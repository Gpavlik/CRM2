<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –≤—ñ–∑–∏—Ç—ñ–≤</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script type="module" src="../shared/Calendar.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    #fullCalendar { max-width: 1000px; margin: 0 auto; }
    .modal {
      position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
      background: #fff; border: 2px solid #333; padding: 20px;
      z-index: 9999; max-width: 800px; width: 90%;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      border-radius: 8px;
    }
    .modal h3 { margin-top: 0; }
    .modal-content div { margin-bottom: 10px; }
    .modal button { margin-top: 10px; padding: 8px; }

  .visit-menu button:hover {
    background:#f0f0f0;
  }
  .visit-menu button {
    display:block;
    width:100%;
    margin:4px 0;
    padding:6px;
    border:none;
    border-radius:4px;
    cursor:pointer;
  }
  .visit-status-zaplanovano {
  background-color: #87CEFA; /* –≥–æ–ª—É–±–∏–π */
  color: #000;
}
.visit-status-provedeno {
  background-color: #32CD32; /* –∑–µ–ª–µ–Ω–∏–π */
  color: #fff;
}
.visit-status-vidmineno {
  background-color: #FF4500; /* —á–µ—Ä–≤–æ–Ω–∏–π */
  color: #fff;
}
.visit-status-pereneseno {
  background-color: #FFA500; /* –æ—Ä–∞–Ω–∂–µ–≤–∏–π */
  color: #000;
}
#visitMenu {
  position: absolute;
  background: #fff;
  border: 1px solid #ccc;
  padding: 10px;
  border-radius: 6px;
  z-index: 9999; /* ‚úÖ –ø–æ–≤–µ—Ä—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
}

  </style>
</head>
<body>
  <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –≤—ñ–∑–∏—Ç—ñ–≤</h2>
  <a href="../labcards/index.html"><button>üè• –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</button></a>
  <div id="fullCalendar"></div>
<div id="visitMenu" class="visit-menu" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:10px; border-radius:6px;">
  <button onclick="onStartVisit()">–†–æ–∑–ø–æ—á–∞—Ç–∏</button>
  <button onclick="onCancelVisit()">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
  <button onclick="onRescheduleVisit()">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>
</div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –Ω–∞ –≤—ñ–∑–∏—Ç—ñ -->
  <div id="visitModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>–í—ñ–∑–∏—Ç –¥–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó</h3>
        <div id="visitTabs"></div>
      <div id="deviceTabs"></div>
      <textarea id="visitNotes" placeholder="–ü—Ä–∏–º—ñ—Ç–∫–∏..." style="width:100%;height:100px;margin-top:10px;"></textarea>
      <div style="margin-top:15px; text-align:right;">
        <button onclick="saveVisit()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button onclick="closeModal()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </div>

<script>
// ===== –†–æ–±–æ—Ç–∞ –∑—ñ —Å—Ö–æ–≤–∏—â–µ–º =====
function loadVisits() {
  return JSON.parse(localStorage.getItem("visits") || "[]");
}
function saveVisits(visits) {
  localStorage.setItem("visits", JSON.stringify(visits));
}

// ===== –Ñ–¥–∏–Ω–∏–π –º–∞–ø—ñ–Ω–≥ —Å—Ç–∞—Ç—É—Å ‚Üí –∫–æ–ª—ñ—Ä (—É–∑–≥–æ–¥–∂–µ–Ω–∏–π –∑—ñ —Å—Ç–∞—Ç—É—Å–∞–º–∏ —É visits) =====
function getStatusColor(status) {
  switch (status) {
    case "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ": return "#87CEFA"; // –≥–æ–ª—É–±–∏–π
    case "–ø—Ä–æ–≤–µ–¥–µ–Ω–æ":   return "#32CD32"; // –∑–µ–ª–µ–Ω–∏–π
    case "–≤—ñ–¥–º—ñ–Ω–µ–Ω–æ":   return "#FF4500"; // —á–µ—Ä–≤–æ–Ω–∏–π
    case "–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ":  return "#FFA500"; // –æ—Ä–∞–Ω–∂–µ–≤–∏–π
    default:            return "#90a4ae"; // —Å—ñ—Ä–∏–π
  }
}

// ===== –ú—ñ–≥—Ä–∞—Ü—ñ—è tasks ‚Üí devices =====
function normalizeVisit(visit) {
  if (visit.devices) return visit; // —è–∫—â–æ –≤–∂–µ —î devices
  const devicesMap = {};
  (visit.tasks || []).forEach(t => {
    if (!devicesMap[t.device]) {
      devicesMap[t.device] = {
        deviceName: t.device,
        forecast: { quantity: 0 },
        agreement: { quantity: 0 },
        fact: { quantity: 0, date: "" },
        testsPerDay: 0,
        reagents: []
      };
    }
    devicesMap[t.device].reagents.push(t.action);
  });
  visit.devices = Object.values(devicesMap);
  return visit;
}

// ===== –†–µ–Ω–¥–µ—Ä —É –∫–æ–º—ñ—Ä–∫–∏ FullCalendar =====
function renderFullCalendar() {
  const visits = loadVisits().map(v => normalizeVisit(v));

  const calendarEl = document.getElementById("fullCalendar");
  if (!calendarEl) {
    console.error("‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä #fullCalendar");
    return;
  }

  // –æ—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–∞–ª–µ–Ω–¥–∞—Ä
  calendarEl.innerHTML = "";

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'uk',
    events: visits.map(v => ({
      id: v.id,
      title: `${v.labName} (${v.status})`,
      start: v.date,          // —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
      color: getStatusColor(v.status)
    })),
    eventClick: function(info) {
      // –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –∫–ª—ñ–∫—É
      showVisitMenu(info.event.id, info.jsEvent.pageX, info.jsEvent.pageY);
    }
  });

  calendar.render();
}

// ===== –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∞–≥–µ–Ω—Ç–∞ –∑ —Ç–µ–∫—Å—Ç—É (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–∞–ª—ñ —É –º–æ–¥–∞–ª—Ü—ñ) =====
function toReagentObjectFromText(text) {
  const trimmed = (text || "").trim();

  // –æ–∫—Ä–µ–º–∏–π –≤–∏–ø–∞–¥–æ–∫ "–°–µ—Ä–≤—ñ—Å"
  if (/^—Å–µ—Ä–≤—ñ—Å$/i.test(trimmed)) {
    return { name: "–°–µ—Ä–≤—ñ—Å", forecast: { quantity: 0 }, agreement: { quantity: 0 }, fact: { quantity: 0, date: "" } };
  }

  // —à—É–∫–∞—î–º–æ "... (N —É–ø.)" —ñ –¥—ñ—Å—Ç–∞—î–º–æ –Ω–∞–∑–≤—É —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
  const m = trimmed.match(/(.+?)\s*\((\d+)\s*—É–ø\.\)/i);
  if (m) {
    return {
      name: m[1].trim(),
      forecast: { quantity: parseInt(m[2], 10) || 0 },
      agreement: { quantity: 0 },
      fact: { quantity: 0, date: "" }
    };
  }

  // —è–∫—â–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –Ω–∞–∑–≤—É
  return {
    name: trimmed,
    forecast: { quantity: 0 },
    agreement: { quantity: 0 },
    fact: { quantity: 0, date: ""
    }
  };
}

// ===== –ü—Ä–æ–≥–Ω–æ–∑ —ñ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—è –ø—Ä–æ–≥–Ω–æ–∑—É —É –Ω–∞—Å—Ç—É–ø–Ω–∏–π –≤—ñ–∑–∏—Ç (–¥–ª—è –º–æ–¥–∞–ª–∫–∏) =====
function calculateNewForecast(device, reagent, daysToNextVisit) {
  const forecast = reagent.forecast?.quantity || 0;
  const fact = reagent.fact?.quantity || 0;
  const testsPerDay = device.testsPerDay || 0;

  const startup = device.calculator?.startup || 0;
  const shutdown = device.calculator?.shutdown || 0;
  const perTest = device.calculator?.perTest || 0;
  const packageSize = device.calculator?.packageSize || 1;

  // 1. –¥–æ–±–æ–≤–µ —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è —É –¥–æ–∑–∞—Ö
  const dailyConsumption = startup + shutdown + (testsPerDay * perTest);

  // 2. –¥–æ–±–æ–≤–∞ –ø–æ—Ç—Ä–µ–±–∞ —É —É–ø–∞–∫–æ–≤–∫–∞—Ö
  const packagesPerDay = Math.ceil(dailyConsumption / packageSize);

  // 3. –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∞ –ø–æ—Ç—Ä–µ–±–∞ –Ω–∞ –ø–µ—Ä—ñ–æ–¥ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –≤—ñ–∑–∏—Ç—É
  const analyticalNeed = packagesPerDay * daysToNextVisit;

  // 4. —Ñ–æ—Ä–º—É–ª–∞ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑—É
  return (forecast - fact) + analyticalNeed;
}

function transferForecastToNextVisit(currentVisit, nextVisit) {
  (currentVisit.devices || []).forEach((device, idx) => {
    const nextDevice = (nextVisit.devices || [])[idx];
    if (!nextDevice) return;

    (device.reagents || []).forEach((r, rIdx) => {
      const nextReagent = (nextDevice.reagents || [])[rIdx];
      if (!nextReagent) return;

      const newForecast = calculateNewForecast(device, r, 30);
      nextReagent.forecast = { quantity: newForecast };
      nextReagent.previousAgreement = { quantity: r.agreement?.quantity || 0 };
    });
  });
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–µ–Ω–¥–µ—Ä–∞ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
window.addEventListener("DOMContentLoaded", renderFullCalendar);

function openVisitModal(visit) {
  const modal = document.getElementById("visitModal");
  const tabs = document.getElementById("visitTabs");
  tabs.innerHTML = "";

  (visit.devices || []).forEach((device, idx) => {
    const tab = document.createElement("div");

    device.reagents = (device.reagents || []).map(r =>
      typeof r === "string" ? toReagentObjectFromText(r) : r
    );

    let reagentsTable = `
      <h4>–ü—Ä–∏–ª–∞–¥: ${device.deviceName}</h4>
      <table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;">
        <tr>
          <th>–†–µ–∞–≥–µ–Ω—Ç</th>
          <th>–ü—Ä–æ–≥–Ω–æ–∑</th>
          <th>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ –¥–æ–º–æ–≤–ª–µ–Ω–æ—Å—Ç—ñ</th>
          <th>–ü–æ—Ç—Ä–µ–±–∞</th>
          <th>–§–∞–∫—Ç (–∫—ñ–ª—å–∫—ñ—Å—Ç—å)</th>
          <th>–§–∞–∫—Ç (–¥–∞—Ç–∞)</th>
          <th>–ê–Ω–∞–ª—ñ–∑—ñ–≤/–¥–µ–Ω—å</th>
        </tr>
    `;

    device.reagents.forEach((r, rIdx) => {
      reagentsTable += `
        <tr>
          <td>${r.name}</td>
          <td><input type="number" id="forecast_${idx}_${rIdx}" value="${r.forecast?.quantity ?? ""}"></td>
          <td><input type="number" id="previousAgreement_${idx}_${rIdx}" value="${r.previousAgreement?.quantity ?? ""}" readonly></td>
          <td><input type="number" id="agreement_${idx}_${rIdx}" value="${r.agreement?.quantity ?? ""}"></td>
          <td><input type="number" id="fact_${idx}_${rIdx}" value="${r.fact?.quantity ?? ""}"></td>
          <td><input type="date" id="factDate_${idx}_${rIdx}" value="${r.fact?.date ?? ""}"></td>
          <td><input type="number" id="testsPerDay_${idx}" value="${device.testsPerDay ?? ""}"></td>
        </tr>
      `;
    });

    reagentsTable += `</table>`;
    tab.innerHTML = reagentsTable;
    tabs.appendChild(tab);

    // ‚úÖ –ø—ñ–¥–∫–ª—é—á–∞—î–º–æ —Å–ª—É—Ö–∞—á—ñ –ø—ñ—Å–ª—è –ø–æ–±—É–¥–æ–≤–∏ —Ç–∞–±–ª–∏—Ü—ñ
    attachForecastListeners(device, idx);
  });

  document.getElementById("visitNotes").value = visit.notes || "";
  modal.style.display = "block";
}

function attachForecastListeners(device, idx) {
  (device.reagents || []).forEach((r, rIdx) => {
    ["forecast", "agreement", "fact", "factDate", "testsPerDay"].forEach(field => {
      const inputId = field === "testsPerDay" ? `testsPerDay_${idx}` : `${field}_${idx}_${rIdx}`;
      const input = document.getElementById(inputId);
      if (input) {
        input.addEventListener("input", () => {
          device.testsPerDay = parseInt(document.getElementById(`testsPerDay_${idx}`).value) || 0;
          r.forecast.quantity = parseInt(document.getElementById(`forecast_${idx}_${rIdx}`).value) || 0;
          r.agreement.quantity = parseInt(document.getElementById(`agreement_${idx}_${rIdx}`).value) || 0;
          r.fact.quantity = parseInt(document.getElementById(`fact_${idx}_${rIdx}`).value) || 0;
          r.fact.date = document.getElementById(`factDate_${idx}_${rIdx}`).value || "";

          // ‚ö†Ô∏è —è–∫—â–æ —Ö–æ—á–µ—à –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–æ–≤–∏–π –ø—Ä–æ–≥–Ω–æ–∑ ‚Äî —Ç—Ä–µ–±–∞ –¥–æ–¥–∞—Ç–∏ –∫–æ–ª–æ–Ω–∫—É —É —Ç–∞–±–ª–∏—Ü—é
          // const newForecast = calculateNewForecast(device, r, 30);
          // document.getElementById(`newForecast_${idx}_${rIdx}`).innerText = newForecast;
        });
      }
    });
  });
}

// ===== –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤ =====
(function autoMigrateReagents() {
  let visits = JSON.parse(localStorage.getItem("visits") || "[]");
  visits.forEach(v => {
    (v.devices || []).forEach(d => {
      d.reagents = (d.reagents || []).map(r =>
        typeof r === "string" ? toReagentObjectFromText(r) : r
      );
    });
  });
  localStorage.setItem("visits", JSON.stringify(visits));
  console.log("‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–∞. –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π —ñ–∑ –∑–∞–¥–∞—á.");
})();

function saveVisit() {
  const visit = window.currentVisit;
  const factUpdates = {};

  (visit.devices || []).forEach((device, idx) => {
    device.testsPerDay = parseInt(document.getElementById(`testsPerDay_${idx}`).value) || 0;

    device.reagents = (device.reagents || []).map((r, rIdx) => {
      const obj = typeof r === "string" ? toReagentObjectFromText(r) : r;
      obj.forecast = { quantity: parseInt(document.getElementById(`forecast_${idx}_${rIdx}`).value) || 0 };
      obj.previousAgreement = { quantity: parseInt(document.getElementById(`previousAgreement_${idx}_${rIdx}`).value) || 0 };
      obj.agreement = { quantity: parseInt(document.getElementById(`agreement_${idx}_${rIdx}`).value) || 0 };
      obj.fact = {
        quantity: parseInt(document.getElementById(`fact_${idx}_${rIdx}`).value) || 0,
        date: document.getElementById(`factDate_${idx}_${rIdx}`).value || ""
      };

      // —Ñ–æ—Ä–º—É—î–º–æ –æ–±‚Äô—î–∫—Ç –¥–ª—è completeVisit
      factUpdates[obj.name] = {
        quantity: obj.fact.quantity,
        date: obj.fact.date
      };

      return obj;
    });
  });

  visit.notes = document.getElementById("visitNotes").value;

  // –≤–∏–∫–ª–∏–∫–∞—î–º–æ completeVisit –∑ —Ñ–∞–∫—Ç–∞–º–∏
  completeVisit(visit.id, factUpdates);

  // –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É
  document.getElementById("visitModal").style.display = "none";
}

function closeModal() {
  document.getElementById("visitModal").style.display = "none";
}

// ===== –õ–æ–≥—ñ–∫–∞ –º–µ–Ω—é =====
let currentVisitId = null;

function showVisitMenu(visitId, x, y) {
  currentVisitId = visitId;
  const menu = document.getElementById("visitMenu");
  menu.style.left = x + "px";
  menu.style.top = y + "px";
  menu.style.display = "block";
}

function hideVisitMenu() {
  document.getElementById("visitMenu").style.display = "none";
}

function onStartVisit() {
  hideVisitMenu();
  const visits = loadVisits();
  const visit = visits.find(v => v.id === currentVisitId);
  if (visit) {
    window.currentVisit = visit;
    openVisitModal(visit); // –≤—ñ–¥–∫—Ä–∏–≤–∞—î –º–æ–¥–∞–ª–∫—É
  }
}

function onCancelVisit() {
  hideVisitMenu();
  cancelVisit(currentVisitId); // –∑–º—ñ–Ω—é—î —Å—Ç–∞—Ç—É—Å –Ω–∞ "–≤—ñ–¥–º—ñ–Ω–µ–Ω–æ"
}

function onRescheduleVisit() {
  hideVisitMenu();
  const newDate = prompt("–í–∏–±–µ—Ä—ñ—Ç—å –Ω–æ–≤—É –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ YYYY-MM-DD:");
  if (newDate) {
    rescheduleVisit(currentVisitId, newDate); // –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –≤—ñ–∑–∏—Ç
  }
}

// ===== –ê–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è –º–µ–Ω—é –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º =====
document.addEventListener("click", function(e) {
  const menu = document.getElementById("visitMenu");
  if (!menu) return;
  if (menu.style.display === "block" && !menu.contains(e.target)) {
    hideVisitMenu();
  }
});

// ===== –ó–∞–∫—Ä–∏—Ç—Ç—è –º–µ–Ω—é –ø–æ Escape =====
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    hideVisitMenu();
    closeModal();
  }
});
</script>
</body>
</html>