<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –≤—ñ–∑–∏—Ç—ñ–≤</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #fullCalendar { max-width: 1000px; margin: 0 auto; }
    .modal {
      position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
      background: #fff; border: 2px solid #333; padding: 20px;
      z-index: 9999; max-width: 800px; width: 90%;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      border-radius: 8px;
    }
    .modal h3 { margin-top: 0; }
    .modal-content div { margin-bottom: 10px; }
    .modal button { margin-top: 10px; padding: 8px; }

  .visit-menu button:hover {
    background:#f0f0f0;
  }
  .visit-menu button {
    display:block;
    width:100%;
    margin:4px 0;
    padding:6px;
    border:none;
    border-radius:4px;
    cursor:pointer;
  }
  .visit-menu 
  </style>
</head>
<body>
  <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –≤—ñ–∑–∏—Ç—ñ–≤</h2>
  <a href="../labcards/index.html"><button>üè• –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</button></a>
  <div id="fullCalendar"></div>
<div id="visitMenu" class="visit-menu" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:10px; border-radius:6px;">
  <button onclick="onStartVisit()">–†–æ–∑–ø–æ—á–∞—Ç–∏</button>
  <button onclick="onCancelVisit()">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
  <button onclick="onRescheduleVisit()">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>
</div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –Ω–∞ –≤—ñ–∑–∏—Ç—ñ -->
  <div id="visitModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>–í—ñ–∑–∏—Ç –¥–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó</h3>
        <div id="visitTabs"></div>
      <div id="deviceTabs"></div>
      <textarea id="visitNotes" placeholder="–ü—Ä–∏–º—ñ—Ç–∫–∏..." style="width:100%;height:100px;margin-top:10px;"></textarea>
      <div style="margin-top:15px; text-align:right;">
        <button onclick="saveVisit()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button onclick="closeModal()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </div>

<script>
function loadVisits() {
  return JSON.parse(localStorage.getItem("visits") || "[]");
}
function saveVisits(visits) {
  localStorage.setItem("visits", JSON.stringify(visits));
}
function getStatusColor(status) {
  switch (status) {
    case "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ": return "#fbc02d";
    case "–≤–∏–∫–æ–Ω–∞–Ω–æ": return "#4caf50";
    case "–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ": return "#ec407a";
    default: return "#90a4ae";
  }
}

// –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ tasks ‚Üí devices
function normalizeVisit(visit) {
  if (visit.devices) return visit; // —è–∫—â–æ –≤–∂–µ —î devices
  const devicesMap = {};
  (visit.tasks || []).forEach(t => {
    if (!devicesMap[t.device]) {
      devicesMap[t.device] = {
        deviceName: t.device,
        forecast: { quantity: 0 },
        agreement: { quantity: 0 },
        fact: { quantity: 0, date: "" },
        testsPerDay: 0,
        reagents: []
      };
    }
    devicesMap[t.device].reagents.push(t.action);
  });
  visit.devices = Object.values(devicesMap);
  return visit;
}

function renderFullCalendar() {
  const calendarEl = document.getElementById("fullCalendar");
  calendarEl.innerHTML = "";

  // –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ –≤—Å—ñ –≤—ñ–∑–∏—Ç–∏
  let visits = loadVisits().map(v => normalizeVisit(v));

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "uk",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek,listWeek"
    },
    events: visits.map(v => ({
      id: v.id,
      title: `üè• ${v.labName}`,
      start: v.date,
      backgroundColor: getStatusColor(v.status),
      borderColor: getStatusColor(v.status),
      extendedProps: v
    })),
    dateClick: function(info) {
      sessionStorage.setItem("selectedDate", info.dateStr);
      window.location.href = "../labcards/index.html";
    },
    eventClick: function(info) {
      let v = info.event.extendedProps;
      v = normalizeVisit(v);   // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ, —â–æ tasks ‚Üí devices
      window.currentVisit = v;
      openVisitModal(v);
    }
  });
element.addEventListener("click", e => {
  showVisitMenu(visit.id, e.pageX, e.pageY);
});
  calendar.render();
}


// –ü–∞—Ä—Å–∏–º–æ –Ω–∞–∑–≤—É —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑ —Ä—è–¥–∫–∞ –∑–∞–¥–∞—á—ñ
function toReagentObjectFromText(text) {
  const trimmed = (text || "").trim();

  // –æ–∫—Ä–µ–º–∏–π –≤–∏–ø–∞–¥–æ–∫ "–°–µ—Ä–≤—ñ—Å"
  if (/^—Å–µ—Ä–≤—ñ—Å$/i.test(trimmed)) {
    return { name: "–°–µ—Ä–≤—ñ—Å", forecast: { quantity: 0 }, agreement: { quantity: 0 }, fact: { quantity: 0, date: "" } };
  }

  // —à—É–∫–∞—î–º–æ "... (N —É–ø.)" —ñ –¥—ñ—Å—Ç–∞—î–º–æ –Ω–∞–∑–≤—É —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
  const m = trimmed.match(/(.+?)\s*\((\d+)\s*—É–ø\.\)/i);
  if (m) {
    return {
      name: m[1].trim(),
      forecast: { quantity: parseInt(m[2], 10) || 0 },
      agreement: { quantity: 0 },
      fact: { quantity: 0, date: "" }
    };
  }

  // —è–∫—â–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –Ω–∞–∑–≤—É
  return {
    name: trimmed,
    forecast: { quantity: 0 },
    agreement: { quantity: 0 },
    fact: { quantity: 0, date: "" }
  };
}
/**
 * –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑—É –¥–ª—è —Ä–µ–∞–≥–µ–Ω—Ç–∞
 * @param {Object} device - –ø—Ä–∏–ª–∞–¥ –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
 * @param {Object} reagent - —Ä–µ–∞–≥–µ–Ω—Ç –∑ forecast/agreement/fact
 * @param {number} daysToNextVisit - –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –≤—ñ–∑–∏—Ç—É
 * @returns {number} –Ω–æ–≤–∏–π –ø—Ä–æ–≥–Ω–æ–∑ (—É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —É–ø–∞–∫–æ–≤–æ–∫)
 */
function calculateNewForecast(device, reagent, daysToNextVisit) {
  const forecast = reagent.forecast?.quantity || 0;
  const fact = reagent.fact?.quantity || 0;
  const testsPerDay = device.testsPerDay || 0;

  const startup = device.calculator?.startup || 0;
  const shutdown = device.calculator?.shutdown || 0;
  const perTest = device.calculator?.perTest || 0;
  const packageSize = device.calculator?.packageSize || 1;

  // 1. –¥–æ–±–æ–≤–µ —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è —É –¥–æ–∑–∞—Ö
  const dailyConsumption = startup + shutdown + (testsPerDay * perTest);

  // 2. –¥–æ–±–æ–≤–∞ –ø–æ—Ç—Ä–µ–±–∞ —É —É–ø–∞–∫–æ–≤–∫–∞—Ö
  const packagesPerDay = Math.ceil(dailyConsumption / packageSize);

  // 3. –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∞ –ø–æ—Ç—Ä–µ–±–∞ –Ω–∞ –ø–µ—Ä—ñ–æ–¥ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –≤—ñ–∑–∏—Ç—É
  const analyticalNeed = packagesPerDay * daysToNextVisit;

  // 4. —Ñ–æ—Ä–º—É–ª–∞ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑—É
  return (forecast - fact) + analyticalNeed;
}
function transferForecastToNextVisit(currentVisit, nextVisit) {
  (currentVisit.devices || []).forEach((device, idx) => {
    const nextDevice = (nextVisit.devices || [])[idx];
    if (!nextDevice) return;

    (device.reagents || []).forEach((r, rIdx) => {
      const nextReagent = (nextDevice.reagents || [])[rIdx];
      if (!nextReagent) return;

      // –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ –Ω–æ–≤–∏–π –ø—Ä–æ–≥–Ω–æ–∑ —É forecast –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ
      const newForecast = calculateNewForecast(device, r, 30);
      nextReagent.forecast = { quantity: newForecast };

      // –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ –ø–æ—Ç—Ä–µ–±—É —É previousAgreement –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ
      nextReagent.previousAgreement = { quantity: r.agreement?.quantity || 0 };
    });
  });
}

function openVisitModal(visit) {
  const modal = document.getElementById("visitModal");
  const tabs = document.getElementById("visitTabs");
  tabs.innerHTML = "";

  (visit.devices || []).forEach((device, idx) => {
    const tab = document.createElement("div");

    device.reagents = (device.reagents || []).map(r =>
      typeof r === "string" ? toReagentObjectFromText(r) : r
    );

    let reagentsTable = `
      <h4>–ü—Ä–∏–ª–∞–¥: ${device.deviceName}</h4>
      <table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;">
        <tr>
          <th>–†–µ–∞–≥–µ–Ω—Ç</th>
          <th>–ü—Ä–æ–≥–Ω–æ–∑</th>
          <th>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ –¥–æ–º–æ–≤–ª–µ–Ω–æ—Å—Ç—ñ</th>
          <th>–ü–æ—Ç—Ä–µ–±–∞</th>
          <th>–§–∞–∫—Ç (–∫—ñ–ª—å–∫—ñ—Å—Ç—å)</th>
          <th>–§–∞–∫—Ç (–¥–∞—Ç–∞)</th>
          <th>–ê–Ω–∞–ª—ñ–∑—ñ–≤/–¥–µ–Ω—å</th>
        </tr>
    `;

    device.reagents.forEach((r, rIdx) => {
      reagentsTable += `
        <tr>
          <td>${r.name}</td>
          <td><input type="number" id="forecast_${idx}_${rIdx}" value="${r.forecast?.quantity ?? ""}"></td>
          <td><input type="number" id="previousAgreement_${idx}_${rIdx}" value="${r.previousAgreement?.quantity ?? ""}" readonly></td>
          <td><input type="number" id="agreement_${idx}_${rIdx}" value="${r.agreement?.quantity ?? ""}"></td>
          <td><input type="number" id="fact_${idx}_${rIdx}" value="${r.fact?.quantity ?? ""}"></td>
          <td><input type="date" id="factDate_${idx}_${rIdx}" value="${r.fact?.date ?? ""}"></td>
          <td><input type="number" id="testsPerDay_${idx}" value="${device.testsPerDay ?? ""}"></td>
        </tr>
      `;
    });

    reagentsTable += `</table>`;
    tab.innerHTML = reagentsTable;
    tabs.appendChild(tab);
  });

  document.getElementById("visitNotes").value = visit.notes || "";
  modal.style.display = "block";
}

function attachForecastListeners(device, idx) {
  (device.reagents || []).forEach((r, rIdx) => {
    ["forecast", "agreement", "fact", "factDate", "testsPerDay"].forEach(field => {
      const inputId = field === "testsPerDay" ? `testsPerDay_${idx}` : `${field}_${idx}_${rIdx}`;
      const input = document.getElementById(inputId);
      if (input) {
        input.addEventListener("input", () => {
          device.testsPerDay = parseInt(document.getElementById(`testsPerDay_${idx}`).value) || 0;
          r.forecast.quantity = parseInt(document.getElementById(`forecast_${idx}_${rIdx}`).value) || 0;
          r.agreement.quantity = parseInt(document.getElementById(`agreement_${idx}_${rIdx}`).value) || 0;
          r.fact.quantity = parseInt(document.getElementById(`fact_${idx}_${rIdx}`).value) || 0;
          r.fact.date = document.getElementById(`factDate_${idx}_${rIdx}`).value || "";

          const newForecast = calculateNewForecast(device, r, 30);
          document.getElementById(`newForecast_${idx}_${rIdx}`).innerText = newForecast;
        });
      }
    });
  });
}


// –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
(function autoMigrateReagents() {
  function toReagentObjectFromText(text) {
    const trimmed = (text || "").trim();

    // –æ–∫—Ä–µ–º–∏–π –≤–∏–ø–∞–¥–æ–∫ "–°–µ—Ä–≤—ñ—Å"
    if (/^—Å–µ—Ä–≤—ñ—Å$/i.test(trimmed)) {
      return {
        name: "–°–µ—Ä–≤—ñ—Å",
        forecast: { quantity: 0 },
        agreement: { quantity: 0 },
        fact: { quantity: 0, date: "" }
      };
    }

    // —à—É–∫–∞—î–º–æ "... (N —É–ø.)"
    const m = trimmed.match(/(.+?)\s*\((\d+)\s*—É–ø\.\)/i);
    if (m) {
      return {
        name: m[1].trim(),
        forecast: { quantity: parseInt(m[2], 10) || 0 },
        agreement: { quantity: 0 },
        fact: { quantity: 0, date: "" }
      };
    }

    // —è–∫—â–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –Ω–∞–∑–≤—É
    return {
      name: trimmed,
      forecast: { quantity: 0 },
      agreement: { quantity: 0 },
      fact: { quantity: 0, date: "" }
    };
  }

  let visits = JSON.parse(localStorage.getItem("visits") || "[]");
  visits.forEach(v => {
    (v.devices || []).forEach(d => {
      d.reagents = (d.reagents || []).map(r =>
        typeof r === "string" ? toReagentObjectFromText(r) : r
      );
    });
  });
  localStorage.setItem("visits", JSON.stringify(visits));
  console.log("‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–∞. –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π —ñ–∑ –∑–∞–¥–∞—á.");
})();


function saveVisit() {
  const visit = window.currentVisit;

  (visit.devices || []).forEach((device, idx) => {
    device.testsPerDay = parseInt(document.getElementById(`testsPerDay_${idx}`).value) || 0;

    device.reagents = (device.reagents || []).map((r, rIdx) => {
      const obj = typeof r === "string" ? toReagentObjectFromText(r) : r;
      obj.forecast = { quantity: parseInt(document.getElementById(`forecast_${idx}_${rIdx}`).value) || 0 };
      obj.previousAgreement = { quantity: parseInt(document.getElementById(`previousAgreement_${idx}_${rIdx}`).value) || 0 };
      obj.agreement = { quantity: parseInt(document.getElementById(`agreement_${idx}_${rIdx}`).value) || 0 };
      obj.fact = {
        quantity: parseInt(document.getElementById(`fact_${idx}_${rIdx}`).value) || 0,
        date: document.getElementById(`factDate_${idx}_${rIdx}`).value || ""
      };
      return obj;
    });
  });

  visit.notes = document.getElementById("visitNotes").value;

  let visits = loadVisits();
  const i = visits.findIndex(v => v.id === visit.id);
  if (i !== -1) visits[i] = visit;

  // –∑–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –≤—ñ–∑–∏—Ç —Ç—ñ—î—ó –∂ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó
  const nextVisit = visits.find(v => v.labId === visit.labId && new Date(v.date) > new Date(visit.date));
  if (nextVisit) {
    transferForecastToNextVisit(visit, nextVisit);
  }

  saveVisits(visits);
  document.getElementById("visitModal").style.display = "none";
  renderFullCalendar();
}

function transferForecastToNextVisit(currentVisit, nextVisit) {
  (currentVisit.devices || []).forEach((device, idx) => {
    const nextDevice = (nextVisit.devices || [])[idx];
    if (!nextDevice) return;

    (device.reagents || []).forEach((r, rIdx) => {
      const nextReagent = (nextDevice.reagents || [])[rIdx];
      if (!nextReagent) return;

      // –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ –Ω–æ–≤–∏–π –ø—Ä–æ–≥–Ω–æ–∑ —É forecast –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ
      const newForecast = calculateNewForecast(device, r, 30);
      nextReagent.forecast = { quantity: newForecast };

      // –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ –ø–æ—Ç—Ä–µ–±—É —É previousAgreement –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ
      nextReagent.previousAgreement = { quantity: r.agreement?.quantity || 0 };
    });
  });
}


function closeModal() {
  document.getElementById("visitModal").style.display = "none";
}

window.addEventListener("DOMContentLoaded", renderFullCalendar);
let currentVisitId = null;

// –í–∏–∫–ª–∏–∫ –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –≤—ñ–∑–∏—Ç —É –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ
function showVisitMenu(visitId, x, y) {
  currentVisitId = visitId;
  const menu = document.getElementById("visitMenu");
  menu.style.left = x + "px";
  menu.style.top = y + "px";
  menu.style.display = "block";
}

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–µ–Ω—é
function hideVisitMenu() {
  document.getElementById("visitMenu").style.display = "none";
}

// –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
function onStartVisit() {
  hideVisitMenu();
  // –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É –¥–ª—è –≤–Ω–µ—Å–µ–Ω–Ω—è —Ñ–∞–∫—Ç—É
  openFactModal(currentVisitId);
}

function onCancelVisit() {
  hideVisitMenu();
  cancelVisit(currentVisitId); // –∑–º—ñ–Ω—é—î —Å—Ç–∞—Ç—É—Å –Ω–∞ "–≤—ñ–¥–º—ñ–Ω–µ–Ω–æ"
}

function onRescheduleVisit() {
  hideVisitMenu();
  const newDate = prompt("–í–∏–±–µ—Ä—ñ—Ç—å –Ω–æ–≤—É –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ YYYY-MM-DD:");
  if (newDate) {
    rescheduleVisit(currentVisitId, newDate); // –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –≤—ñ–∑–∏—Ç
  }
}

</script>
</body>
</html>
