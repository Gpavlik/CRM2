<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –≤—ñ–∑–∏—Ç—ñ–≤</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #fullCalendar { max-width: 1000px; margin: 0 auto; }
    .task-modal {
      position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
      background: #fff; border: 2px solid #333; padding: 20px;
      z-index: 9999; max-width: 400px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .task-modal h3 { margin-top: 0; }
    .task-modal ul { margin: 10px 0; padding-left: 20px; }
    .task-modal button { margin-top: 10px; padding: 8px; }
  </style>
</head>
<body>
  <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –≤—ñ–∑–∏—Ç—ñ–≤</h2>
  <a href="../labcards/index.html"><button>üè• –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</button></a>
  <div id="fullCalendar"></div>

<script>
function loadVisits() {
  return JSON.parse(localStorage.getItem("visits") || "[]");
}

function saveVisits(visits) {
  localStorage.setItem("visits", JSON.stringify(visits));
}

function getStatusColor(status) {
  switch (status) {
    case "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ": return "#fbc02d";
    case "–≤–∏–∫–æ–Ω–∞–Ω–æ": return "#4caf50";
    case "–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ": return "#ec407a";
    default: return "#90a4ae";
  }
}

function renderFullCalendar() {
  const calendarEl = document.getElementById("fullCalendar");
  calendarEl.innerHTML = "";

  const visits = loadVisits();

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "uk",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek,listWeek"
    },
    events: visits.map(v => ({
      id: v.id,
      title: `üè• ${v.labName}`,
      start: v.date, // –Ω–∞–ø—Ä—è–º—É, –±–µ–∑ new Date()
      backgroundColor: getStatusColor(v.status),
      borderColor: getStatusColor(v.status),
      extendedProps: v
    })),
    // –∫–ª—ñ–∫ –ø–æ –¥–∞—Ç—ñ ‚Üí –≤–∏–±—ñ—Ä –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó
    dateClick: function(info) {
      sessionStorage.setItem("selectedDate", info.dateStr);
      window.location.href = "../labcards/index.html";
    },
    // –∫–ª—ñ–∫ –ø–æ –ø–æ–¥—ñ—ó ‚Üí –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –∑–∞–¥–∞—á–∞–º–∏
    eventClick: function(info) {
      const v = info.event.extendedProps;
      const modal = document.createElement("div");
      modal.className = "task-modal";
      modal.innerHTML = `
        <h3>üìÖ –í—ñ–∑–∏—Ç –¥–æ ${v.labName} (${v.date})</h3>
        <ul>
          ${v.tasks.map(t => `<li>üîß ${t.device}: ${t.priority} ‚Äî ${t.title || t.action}</li>`).join("")}
        </ul>
        <label>üìå –°—Ç–∞—Ç—É—Å:
          <select id="visitStatus">
            <option value="–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ" ${v.status==="–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ"?"selected":""}>–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ</option>
            <option value="–≤–∏–∫–æ–Ω–∞–Ω–æ" ${v.status==="–≤–∏–∫–æ–Ω–∞–Ω–æ"?"selected":""}>–í–∏–∫–æ–Ω–∞–Ω–æ</option>
            <option value="–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ" ${v.status==="–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ"?"selected":""}>–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ</option>
          </select>
        </label><br>
        <button onclick="saveVisitStatus('${v.id}')">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button onclick="this.closest('.task-modal').remove()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
      `;
      document.body.appendChild(modal);
    }
  });

  calendar.render();
}

function saveVisitStatus(visitId) {
  const visits = loadVisits();
  const idx = visits.findIndex(v => v.id === visitId);
  if (idx !== -1) {
    visits[idx].status = document.getElementById("visitStatus").value;
    saveVisits(visits);
    document.querySelector(".task-modal")?.remove();
    renderFullCalendar();
  }
}

window.addEventListener("DOMContentLoaded", renderFullCalendar);
</script>
</body>
</html>
