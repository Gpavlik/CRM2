<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –∑–∞–¥–∞—á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #fullCalendar {
      max-width: 1000px;
      margin: 0 auto;
    }
    .fc-event-title {
      font-weight: bold;
    }
    .task-modal {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid #333;
      padding: 20px;
      z-index: 9999;
      max-width: 400px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .task-editor {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .task-editor input,
    .task-editor select {
      padding: 6px;
      font-size: 1rem;
    }
    .task-editor button {
      padding: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    .filters {
      margin-bottom: 20px;
    }
    .filters label {
      margin-right: 20px;
    }
  </style>
</head>
<body>
  <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –∑–∞–¥–∞—á (FullCalendar)</h2>

  <div class="filters">
    <label>üè¢ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è:
      <select id="filterLab" onchange="renderFullCalendar()">
        <option value="">–£—Å—ñ</option>
      </select>
    </label>
    <label>üîß –ü—Ä–∏–ª–∞–¥:
      <select id="filterDevice" onchange="renderFullCalendar()">
        <option value="">–£—Å—ñ</option>
      </select>
    </label>
    <label>üìå –°—Ç–∞—Ç—É—Å:
      <select id="filterStatus" onchange="renderFullCalendar()">
        <option value="">–£—Å—ñ</option>
        <option value="–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ">–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ</option>
        <option value="–≤–∏–∫–æ–Ω–∞–Ω–æ">–í–∏–∫–æ–Ω–∞–Ω–æ</option>
        <option value="–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ">–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ</option>
      </select>
    </label>
    <a href="../labcards/index.html">
      <button style="margin-left: 20px;">üè• –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</button>
    </a>
    <button onclick="insertVisitFromLabcards()">üì• –î–æ–¥–∞—Ç–∏ –≤—ñ–∑–∏—Ç —ñ–∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</button>
  </div>

  <div id="fullCalendar"></div>
<script type="module" src="../labcards/labcards.js"></script>
<script type="module" src="../labcards/logistics.js"></script>
<script type="module" src="../shared/Calendar.js"></script>

 <script>
    function loadCalendarTasks() {
      return JSON.parse(localStorage.getItem("calendarTasks") || "[]");
    }

    function updateTask(updatedTask) {
      const tasks = loadCalendarTasks();
      const index = tasks.findIndex(t => t.id === updatedTask.id);
      if (index !== -1) {
        tasks[index] = updatedTask;
        localStorage.setItem("calendarTasks", JSON.stringify(tasks));
      }
    }

    function extractTestCount(title) {
      const match = title.match(/‚Äî\s*(\d+)\s*—Ç–µ—Å—Ç—ñ–≤/);
      return match ? +match[1] : 0;
    }

    function getStatusColor(status) {
      switch (status) {
        case "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ": return "#fbc02d";
        case "–≤–∏–∫–æ–Ω–∞–Ω–æ": return "#4caf50";
        case "–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ": return "#ec407a";
        default: return "#90a4ae";
      }
    }

    function fillFilterOptions(tasks) {
      const labSet = new Set();
      const deviceSet = new Set();

      tasks.forEach(t => {
        labSet.add(t.lab);
        deviceSet.add(t.device);
      });

      const labSelect = document.getElementById("filterLab");
      const deviceSelect = document.getElementById("filterDevice");

      labSelect.innerHTML = '<option value="">–£—Å—ñ</option>';
      deviceSelect.innerHTML = '<option value="">–£—Å—ñ</option>';

      Array.from(labSet).sort().forEach(lab => {
        const opt = document.createElement("option");
        opt.value = lab;
        opt.textContent = lab;
        labSelect.appendChild(opt);
      });

      Array.from(deviceSet).sort().forEach(dev => {
        const opt = document.createElement("option");
        opt.value = dev;
        opt.textContent = dev;
        deviceSelect.appendChild(opt);
      });
    }

    function renderFullCalendar() {
      const calendarEl = document.getElementById("fullCalendar");
      calendarEl.innerHTML = "";

      const allTasks = loadCalendarTasks();
      fillFilterOptions(allTasks);

      const selectedLab = document.getElementById("filterLab").value;
      const selectedDevice = document.getElementById("filterDevice").value;
      const selectedStatus = document.getElementById("filterStatus").value;

      const filteredTasks = allTasks.filter(task => {
        return (
          (!selectedLab || task.lab === selectedLab) &&
          (!selectedDevice || task.device === selectedDevice) &&
          (!selectedStatus || task.status === selectedStatus)
        );
      });

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "uk",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,listWeek"
        },
        events: filteredTasks.map(task => ({
          id: task.id,
          title: task.title,
          start: task.date,
          backgroundColor: getStatusColor(task.status),
          borderColor: getStatusColor(task.status),
          extendedProps: {
            description: task.description,
            lab: task.lab,
            device: task.device,
            status: task.status
          }
        })),
        eventClick: function(info) {
          const task = info.event.extendedProps;
          const modal = document.createElement("div");
          modal.className = "task-modal";
          modal.innerHTML = `
            <div class="task-modal-content">
              <h3>‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–¥–∞—á—ñ</h3>
              <form class="task-editor">
                <label>üìÖ –î–∞—Ç–∞:
                  <input type="date" name="date" value="${info.event.startStr}">
                </label>
                <label>üî¢ –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–µ—Å—Ç—ñ–≤:
                  <input type="number" name="count" value="${extractTestCount(info.event.title)}">
                </label>
                <label>üìå –°—Ç–∞—Ç—É—Å:
                  <select name="status">
                    <option value="–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ" ${task.status === "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ" ? "selected" : ""}>–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ</option>
                    <option value="–≤–∏–∫–æ–Ω–∞–Ω–æ" ${task.status === "–≤–∏–∫–æ–Ω–∞–Ω–æ" ? "selected" : ""}>–í–∏–∫–æ–Ω–∞–Ω–æ</option>
                    <option value="–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ" ${task.status === "–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ" ? "selected" : ""}>–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ</option>
                  </select>
                </label>
                <button type="submit">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button type="button" onclick="this.closest('.task-modal').remove()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
              </form>
            </div>
          `;
          document.body.appendChild(modal);

          modal.querySelector("form").onsubmit = (e) => {
            e.preventDefault();
            const f = e.target;
            const updatedTask = {
              id: info.event.id,
              date: f.date.value,
              title: `üî¨ ${info.event.title.split("‚Äî")[0].trim()} ‚Äî ${+f.count.value} —Ç–µ—Å—Ç—ñ–≤`,
              description: task.description,
              lab: task.lab,
              device: task.device,
              status: f.status.value
            };
            updateTask(updatedTask);
            modal.remove();
            renderFullCalendar();
          };
        }
      });

      calendar.render();
    }

    function insertVisitFromLabcards() {
      const visitData = sessionStorage.getItem("newVisit");
      if (!visitData) {
        alert("–ù–µ–º–∞—î –Ω–æ–≤–æ–≥–æ –≤—ñ–∑–∏—Ç—É –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è.");
        return;
      }

      const visit = JSON.parse(visitData);
      const tasks = visit.tasks || [];

      const calendarTasks = loadCalendarTasks();
      const newTasks = tasks.map((t, i) => ({
        id: `${visit.labId}_${i}_${Date.now()}`,
        title: `üî¨ ${t.device} ‚Äî ${t.priority} ${t.action}`,
        date: visit.date,
        description: `${t.action} –¥–ª—è ${t.device}`,
        lab: visit.labId,
        device: t.device,
        status: "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ"
      }));

            const updatedTasks = [...calendarTasks, ...newTasks];
      localStorage.setItem("calendarTasks", JSON.stringify(updatedTasks));
      sessionStorage.removeItem("newVisit");
      renderFullCalendar();
    }

    window.addEventListener("DOMContentLoaded", renderFullCalendar);
  </script>
</body>
</html>
