<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #006400, #004d00);
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin-top: 30px; text-align: center; }
    .login-box, .dashboard {
      max-width: 500px; width: 90%;
      margin: 40px auto; padding: 25px;
      background: #008000; border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }
    input {
      width: 96%; padding: 10px; margin: 0 auto 15px auto;
      border: none; border-radius: 6px; font-size: 1rem;
    }
    button {
      width: 100%; padding: 12px; margin-top: 10px;
      background-color: #004d00; color: #ffffff;
      border: none; border-radius: 6px; font-size: 1rem;
      cursor: pointer; transition: background 0.3s ease;
    }
    button:hover { background-color: #003300; }
    .result { margin-top: 15px; font-size: 0.85rem; text-align: center; }
    .menu { display: flex; flex-direction: column; gap: 12px; }
    .menu button { background: #006400; }
    #progressBox { display:none; padding:10px; border:1px solid #ccc; margin:10px 0; background:#fff; color:#000; border-radius:8px; }
    #progressBox h4 { margin:0 0 8px 0; }
    .promo-modal {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.5);
  display:flex;
  justify-content:center;
  align-items:center;
}
.promo-content {
  background: #008000;
  padding:20px;
  border-radius:8px;
  width:90%;
  max-width:1000px;
  max-height:90vh;
  overflow-y:auto; /* ‚úÖ —Å–∫—Ä–æ–ª */
}
.promo-grid {
  display:flex;
  flex-wrap:wrap; /* ‚úÖ –≤—Ä–∞–ø */
  gap:20px;
}
.promo-item {
  flex:1 1 250px;
  border:1px solid #ccc;
  padding:10px;
  border-radius:6px;
}
.promo-item h4 {
  margin-bottom:10px;
}
.promo-material {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:4px 0;
}
.promo-material input[type="number"] {
  width:60px;
}
.promo-material textarea {
  width:100%;
  margin-top:5px;
  resize:none;
}
@media (max-width:600px) {
  .promo-item {
    flex:1 1 100%; /* ‚úÖ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ */
  }
}
.promo-item img {
  width: 100px;
  height: 100px;
  object-fit: contain;
  margin-bottom: 8px;
  border-radius: 10px;
}

</style>
</head>
<body>
  <h1>üî¨ Pharmasco CRM</h1>
  <img src="./logo.svg" alt="logo" width="560">

  <!-- –í—Ö—ñ–¥ -->
  <div class="login-box" id="loginBox">
    <h2>–í—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É</h2>
    <input type="text" id="login" placeholder="–õ–æ–≥—ñ–Ω">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="authenticate()">–£–≤—ñ–π—Ç–∏</button>
    <div class="result" id="result"></div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard" style="display:none;">
    <h2>üëã –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</h2>
    <p id="userRole"></p>
    <div class="menu">
      <button type="button" onclick="startDay()">üåÖ –ü–æ—á–∞—Ç–∏ –¥–µ–Ω—å</button>
      <button onclick="goToCalendar()">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä</button>
      <button onclick="goToLabs()">üß™ –ü–µ—Ä–µ–ª—ñ–∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</button>
      <button type="button" onclick="createNewLab()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é</button>
      <a href="https://gpavlik.github.io/farm_work/portfolio.html" target="_blank" rel="noopener"><button type="button">–ö–æ—Ä–∏—Å–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</button></a>
      <button onclick="goToReport()">üìä –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∑–≤—ñ—Ç–∏</button>
      <button type="button" onclick="askForPromo()">üßπ –ó–∞–º–æ–≤–∏—Ç–∏ –ø—Ä–æ–º–æ</button>
      <button type="button" onclick="endDay()">üåá –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –¥–µ–Ω—å</button>
      <button onclick="logout()">üö™ –í–∏–π—Ç–∏</button>
    </div>
    <div id="progressBox">
      <h4>üìä –°—Ç–∞–Ω –ø—Ä–æ—Ü–µ—Å—É</h4>
      <ul id="progressList"></ul>
    </div>
    <!-- –ü—Ä–æ–≥—Ä–µ—Å–±–∞—Ä -->
<div id="progressContainer" style="width:100%; background:#333; border-radius:8px; margin:10px 0; height:24px;">
  <div id="progressBar" style="width:0%; height:100%; background:red; border-radius:8px; text-align:center; color:#fff; font-size:12px;">
    0%
  </div>
</div>

  </div>

  <img src="./ivd.png" alt="logo" width="560">
<div id="promoModal" class="promo-modal" style="display:none;">
  <div class="promo-content">
    <h2>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–º–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</h2>
    <div id="promoGrid" class="promo-grid"></div>

    <h3>üéÅ –°–µ—Ä–≤—ñ—Å–Ω—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏</h3>
    <div id="giftGrid" class="promo-grid"></div>

    <button onclick="submitPromoOrder()">üì§ –ó–∞–º–æ–≤–∏—Ç–∏</button>
    <button onclick="closePromoModal()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
  </div>
</div>

<script>
let currentUser = null;
let token = null;

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
async function authenticate() {
  const login = document.getElementById("login").value;
  const password = document.getElementById("password").value;

  try {
    const response = await fetch("https://nodejs-production-7176.up.railway.app/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ login, password })
    });

    const result = await response.json();

    if (response.status === 200) {
      currentUser = login;
      token = result.token;
      sessionStorage.setItem("token", token);
            showDashboard(result.role);
      showProgress("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞", "success");
    } else {
      document.getElementById("result").innerHTML =
        `<p style='color:red'>‚ùå ${result.error}</p>`;
      showProgress("‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –Ω–µ –≤–¥–∞–ª–∞—Å—è", "error");
    }
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó:", err);
    showProgress("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó", "error");
  }
}

function showDashboard(role) {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
  document.getElementById("userRole").innerHTML =
    `‚úÖ –í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ <b>${role}</b>`;
}

function showLogin() {
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
}

function isTokenValid(token) {
  try {
    const payload = JSON.parse(atob(token.split(".")[1]));
    return payload.exp * 1000 > Date.now();
  } catch {
    return false;
  }
}

// üîé –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
window.onload = async () => {
  const savedToken = sessionStorage.getItem("token");
  if (savedToken && isTokenValid(savedToken)) {
    try {
      const res = await fetch("https://nodejs-production-7176.up.railway.app/labs", {
        headers: { "Authorization": "Bearer " + savedToken }
      });

      if (res.status === 403) {
        showLogin();
      } else {
        const payload = JSON.parse(atob(savedToken.split(".")[1]));
        showDashboard(payload.role);
        showProgress("‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π, –≤–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ " + payload.role, "success");
      }
    } catch {
      showLogin();
    }
  } else {
    showLogin();
  }
};

// –ù–∞–≤—ñ–≥–∞—Ü—ñ—è
function goToLabs() { window.location.href = "./labcards/labs.html"; }
function goToLabCard() { sessionStorage.removeItem("editLabId"); window.location.href = "./labcards/labcard.html"; }
function goToCalendar() { window.location.href = "./calendar/calendar.html"; }
function goToReport() { window.location.href = "./reports/index.html"; }

function logout() {
  currentUser = null;
  token = null;
  sessionStorage.removeItem("token");
  showLogin();
  document.getElementById("result").innerHTML = `<p>üö™ –í–∏ –≤–∏–π—à–ª–∏ —ñ–∑ —Å–∏—Å—Ç–µ–º–∏</p>`;
  showProgress("üö™ –í–∏ –≤–∏–π—à–ª–∏ —ñ–∑ —Å–∏—Å—Ç–µ–º–∏", "info");
}
// === progress.js ===
function showProgress(message, type="info") {
  const box = document.getElementById("progressBox");
  const list = document.getElementById("progressList");
  box.style.display = "block";

  const li = document.createElement("li");
  li.textContent = message;

  switch (type) {
    case "success":
      li.style.color = "green";
      break;
    case "error":
      li.style.color = "red";
      break;
    case "info":
      li.style.color = "blue";
      break;
  }

  list.appendChild(li);
}

// === IndexedDB helpers ===
const DB_NAME = "labsDB";
const DB_VERSION = 3; // –ø—ñ–¥–Ω—è—Ç–∞ –≤–µ—Ä—Å—ñ—è
const LABS_STORE = "labs";
const VISITS_STORE = "visits";
const TASKS_STORE = "tasks";

// ==========================
// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è IndexedDB
// ==========================
function initDB() {
  const request = indexedDB.open(DB_NAME, DB_VERSION);

  request.onupgradeneeded = (event) => {
    const db = event.target.result;
    console.log("onupgradeneeded fired, —Å—Ç–≤–æ—Ä—é—î–º–æ stores...");

    if (!db.objectStoreNames.contains(LABS_STORE)) {
      db.createObjectStore(LABS_STORE);
    }
    if (!db.objectStoreNames.contains(VISITS_STORE)) {
      db.createObjectStore(VISITS_STORE);
    }
    if (!db.objectStoreNames.contains(TASKS_STORE)) {
      db.createObjectStore(TASKS_STORE);
    }
  };

  request.onsuccess = () => {
    console.log("‚úÖ IndexedDB —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –∑ labs, visits, tasks");
  };

  request.onerror = (err) => {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó IndexedDB:", err);
  };
}

// ==========================
// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–∞—Å–∏–≤—É –æ–±'—î–∫—Ç—ñ–≤
// ==========================
async function saveToDB(storeName, items) {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onsuccess = (event) => {
      const db = event.target.result;
      const tx = db.transaction(storeName, "readwrite");
      const store = tx.objectStore(storeName);

      items.forEach(item => {
        if (!item.edrpou) {
          console.warn("–ü—Ä–æ–ø—É—â–µ–Ω–æ –æ–±‚Äô—î–∫—Ç –±–µ–∑ edrpou:", item);
          return;
        }
        store.put(item, item.edrpou); // –∫–ª—é—á = edrpou
      });

      tx.oncomplete = () => resolve(true);
      tx.onerror = (err) => reject(err);
    };
    request.onerror = (err) => reject(err);
  });
}

// ==========================
// –ß–∏—Ç–∞–Ω–Ω—è
// ==========================
async function getAllFromDB(storeName) {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onsuccess = (event) => {
      const db = event.target.result;
      const tx = db.transaction(storeName, "readonly");
      const store = tx.objectStore(storeName);
      const getRequest = store.getAll();

      getRequest.onsuccess = () => resolve(getRequest.result);
      getRequest.onerror = (err) => reject(err);
    };
    request.onerror = (err) => reject(err);
  });
}
// ==========================
// –ú–∞—Ä–∫–µ—Ä —á–∞—Å—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
// ==========================
function getLastSync() {
  return parseInt(sessionStorage.getItem("lastSync") || "0", 10);
}
function setLastSync(timestamp) {
  sessionStorage.setItem("lastSync", timestamp.toString());
}

// ==========================
// –§–µ—Ç—á –∑–º—ñ–Ω –∑ –±–µ–∫–µ–Ω–¥—É (–¥–µ–ª—å—Ç–∞)
// ==========================
async function fetchLabsAndVisits() {
  const API_URL = "https://nodejs-production-7176.up.railway.app";
  const token = sessionStorage.getItem("token");
  const lastSync = getLastSync();

  try {
    let labsRes, visitsRes;

    if (lastSync === 0) {
      labsRes = await fetch(`${API_URL}/labs`, { headers: { "Authorization": "Bearer " + token } });
      visitsRes = await fetch(`${API_URL}/visits`, { headers: { "Authorization": "Bearer " + token } });
    } else {
      labsRes = await fetch(`${API_URL}/labs/changes?since=${lastSync}`, { headers: { "Authorization": "Bearer " + token } });
      visitsRes = await fetch(`${API_URL}/visits/changes?since=${lastSync}`, { headers: { "Authorization": "Bearer " + token } });
    }

    const labsRaw = await labsRes.json();
    const visitsRaw = await visitsRes.json();

    await saveToDB("labs", labsRaw);
    await saveToDB("visits", visitsRaw);

    setLastSync(Date.now());
    console.log("‚úÖ –§–µ—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ (–¥–µ–ª—å—Ç–∞)");
    return { labs: labsRaw, visits: visitsRaw };
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ fetch:", err);
    return { labs: [], visits: [] };
  }
}

// ==========================
// –ü—É—à –∑–º—ñ–Ω –Ω–∞ –±–µ–∫–µ–Ω–¥ (–¥–µ–ª—å—Ç–∞)
// ==========================
async function pushLabsAndVisits() {
  const API_URL = "https://nodejs-production-7176.up.railway.app";
  const token = sessionStorage.getItem("token");
  const lastSync = getLastSync();

  try {
    const labsUnified = await getAllFromDB("labs");
    const visits = await getAllFromDB("visits");

    const labsForBackend = labsUnified.filter(l => l.updatedAt && l.updatedAt > lastSync);
    const visitsForBackend = visits.filter(v => v.updatedAt && v.updatedAt > lastSync);

    await Promise.all([
      fetch(`${API_URL}/labs/update`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body: JSON.stringify(labsForBackend)
      }),
      fetch(`${API_URL}/visits/update`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body: JSON.stringify(visitsForBackend)
      })
    ]);

    setLastSync(Date.now());
    console.log("‚úÖ –ü—É—à –∑–∞–≤–µ—Ä—à–µ–Ω–æ (–¥–µ–ª—å—Ç–∞)");
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ push:", err);
  }
}

// ==========================
// –°—Ç–∞—Ä—Ç –¥–Ω—è
// ==========================
async function startDay() {
  try {
    initDB(); // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ, —â–æ –±–∞–∑–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞
    const { labs, visits } = await fetchLabsAndVisits();
    console.log("‚úÖ –î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —É IndexedDB");

    renderLabs(labs);
    renderVisits(visits);

    showProgress("üåÖ –†–æ–±–æ—á–∏–π –¥–µ–Ω—å —Ä–æ–∑–ø–æ—á–∞—Ç–æ!", "success");
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –¥–Ω—è:", err);
    showProgress("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –¥–µ–Ω—å", "error");
  }
}

// ==========================
// –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–Ω—è
// ==========================
async function endDay() {
  showProgress("üì§ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω –Ω–∞ –±–µ–∫–µ–Ω–¥...");
  updateProgress(0);

  try {
    for (let i = 0; i <= 50; i++) {
      updateProgress(i);
      await new Promise(r => setTimeout(r, 20));
    }

    await pushLabsAndVisits();

    for (let i = 51; i <= 100; i++) {
      updateProgress(i);
      await new Promise(r => setTimeout(r, 20));
    }

    showProgress("üåá –ó–º—ñ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ!", "success");
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó:", err);
    showProgress("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó", "error");
    updateProgress(0);
  }
}
function renderLabs(labs) {
  console.log("üìã –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞:", labs.length);
  // TODO: —Ç—É—Ç –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É —Ç–∞–±–ª–∏—Ü—ñ/—Å–ø–∏—Å–∫—É
  const box = document.getElementById("progressBox");
  const list = document.getElementById("progressList");
  const li = document.createElement("li");
  li.textContent = `üß™ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${labs.length} –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π`;
  list.appendChild(li);
}

function renderVisits(visits) {
  console.log("üìã –í—ñ–∑–∏—Ç–∏ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞:", visits.length);
  // TODO: —Ç—É—Ç –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É —Ç–∞–±–ª–∏—Ü—ñ/—Å–ø–∏—Å–∫—É
  const box = document.getElementById("progressBox");
  const list = document.getElementById("progressList");
  const li = document.createElement("li");
  li.textContent = `üìÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${visits.length} –≤—ñ–∑–∏—Ç—ñ–≤`;
  list.appendChild(li);
}

// === —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö ===

// –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤
function getLatestReagentsInfo(allOrders) {
  const latestInfo = {};
  for (const order of allOrders) {
    const { reagentName, lastOrderDate, lastOrderCount } = order;
    if (
      !latestInfo[reagentName] ||
      new Date(lastOrderDate) > new Date(latestInfo[reagentName].lastOrderDate)
    ) {
      latestInfo[reagentName] = { lastOrderDate, lastOrderCount };
    }
  }
  return latestInfo;
}

// –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è –∑ –±–µ–∫–µ–Ω–¥—É —É –ª–æ–∫–∞–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
function transformLabFromBackend(lab) {
  return {
    ...lab,
    updatedAt: lab.updatedAt || Date.now(), // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å updatedAt
    devices: (lab.devices || []).map(d => {
      const reagentsOrders = (d.reagents || []).map(r => ({
        reagentName: r.name,
        lastOrderDate: r.date,
        lastOrderCount: r.quantity
      }));
      const reagentsInfo = getLatestReagentsInfo(reagentsOrders);
      return {
        ...d,
        reagentsOrders,
        reagentsInfo,
        analyses: d.analyses || {}
      };
    })
  };
}

// –ó–≤–æ—Ä–æ—Ç–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è —É —Ñ–æ—Ä–º–∞—Ç –±–µ–∫–µ–Ω–¥—É
function transformLabToBackend(lab) {
  return {
    ...lab,
    updatedAt: lab.updatedAt || Date.now(), // –∑–∞–≤–∂–¥–∏ –¥–æ–¥–∞—î–º–æ –º—ñ—Ç–∫—É —á–∞—Å—É
    devices: (lab.devices || []).map(d => ({
      ...d,
      reagents: (d.reagentsOrders || []).map(r => ({
        name: r.reagentName,
        date: r.lastOrderDate,
        quantity: r.lastOrderCount
      }))
    }))
  };
}

// === –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó ===
function createNewLab() {
  sessionStorage.removeItem("currentLabEdrpou");
  window.location.href = "./labcards/labcard.html";
}

// –ü—Ä–æ–≥—Ä–µ—Å–±–∞—Ä
function updateProgress(percent) {
  const bar = document.getElementById("progressBar");
  bar.style.width = percent + "%";
  bar.textContent = percent + "%";

  // –ø–ª–∞–≤–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –∫–æ–ª—å–æ—Ä—É –≤—ñ–¥ —á–µ—Ä–≤–æ–Ω–æ–≥–æ –¥–æ –∑–µ–ª–µ–Ω–æ–≥–æ
  const red = Math.max(0, 255 - Math.floor(percent * 2.55));
  const green = Math.min(255, Math.floor(percent * 2.55));
  bar.style.backgroundColor = `rgb(${red},${green},0)`;
}

// –°–∏–º—É–ª—è—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
async function simulateLoading() {
  for (let i = 0; i <= 100; i++) {
    updateProgress(i);
    await new Promise(r => setTimeout(r, 50));
  }
}

// –û—á–∏—Å—Ç–∫–∞ IndexedDB
async function clearIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.deleteDatabase("labsDB");

    request.onsuccess = () => {
      console.log("üßπ IndexedDB –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—â–µ–Ω–æ");
      resolve(true);
    };
    request.onerror = (event) => {
      console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ IndexedDB:", event);
      reject(event);
    };
    request.onblocked = () => {
      console.warn("‚ö†Ô∏è –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ. –ó–∞–∫—Ä–∏–π —ñ–Ω—à—ñ –≤–∫–ª–∞–¥–∫–∏ –∑ —Ü—ñ—î—é –±–∞–∑–æ—é.");
    };
  });
}
//========================
// –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–º–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
//========================
function askForPromo() {
  const devices = [
    "CLreader300","LS1100","DH36","DF50","UN73",
    "YHLO","BK120","Bioassays240Plus","ISE","DP-C16","CA1200"
  ];

  const promoTypes = ["–ª–∏—Å—Ç—ñ–≤–∫–∞"];
  const gifts = ["–ö–∞–ª–µ–Ω–¥–∞—Ä","–ë–ª–æ–∫–Ω–æ—Ç","–†—É—á–∫–∞"];

  const imageMap = {
    "CLreader300": "CL300.webp",
    "LS1100": "ls1100.webp",
    "DH36": "dh36.webp",
    "DF50": "df50.webp",
    "UN73": "un73.webp",
    "YHLO": "yhlo.webp",
    "BK120": "BK120.jpeg",
    "Bioassays240Plus": "240.webp",
    "ISE": "ise.png",
    "DP-C16": "dpc16.bmp",
    "CA1200": "CA1200.png",
    // –ø–æ–¥–∞—Ä—É–Ω–∫–∏
    "–ö–∞–ª–µ–Ω–¥–∞—Ä": "cal.webp",
    "–ë–ª–æ–∫–Ω–æ—Ç": "bloc.jpg",
    "–†—É—á–∫–∞": "pen.jpeg"
  };

  // –ø—Ä–∏–ª–∞–¥–∏
  const grid = document.getElementById("promoGrid");
  grid.innerHTML = "";

  devices.forEach(dev => {
    const div = document.createElement("div");
    div.className = "promo-item";
    const imgFile = imageMap[dev] || "default.png"; // fallback
    div.innerHTML = `
      <img src="images/${imgFile}" alt="${dev}">
      <h4>${dev}</h4>
    `;
    promoTypes.forEach(type => {
      div.innerHTML += `
        <div class="promo-material">
          <span>${type}</span>
          <input type="number" id="qty_${dev}_${type}" min="0" placeholder="0">
        </div>`;
    });
    grid.appendChild(div);
  });

  // –ø–æ–¥–∞—Ä—É–Ω–∫–∏
  const giftGrid = document.getElementById("giftGrid");
  giftGrid.innerHTML = "";

  gifts.forEach(gift => {
    const div = document.createElement("div");
    div.className = "promo-item";
    const imgFile = imageMap[gift] || "default.png";
    div.innerHTML = `
      <img src="images/${imgFile}" alt="${gift}">
      <h4>${gift}</h4>
      <div class="promo-material">
        <span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</span>
        <input type="number" id="qty_gift_${gift}" min="0" placeholder="0">
      </div>
      <textarea id="comment_gift_${gift}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä"></textarea>
    `;
    giftGrid.appendChild(div);
  });

  document.getElementById("promoModal").style.display = "flex";
}

function closePromoModal() {
  document.getElementById("promoModal").style.display = "none";
}

function login(username, password) {
  // —Ç—É—Ç —Ç–≤–æ—è –ª–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ª–æ–≥—ñ–Ω—É/–ø–∞—Ä–æ–ª—é
  if (username && password) {
    document.getElementById("dashboard").style.display = "block";
    document.getElementById("userRole").textContent = `‚òë –í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ ${username}`;
  }
}

function getLoginName() {
  const text = document.getElementById("userRole")?.textContent || "";
  const match = text.match(/—è–∫\s+(.+)/);
  return match ? match[1].trim() : "–Ω–µ–≤—ñ–¥–æ–º–∏–π";
}

function submitPromoOrder() {
  const order = {};

  // –∑–±—ñ—Ä –ø–æ –ø—Ä–∏–ª–∞–¥–∞—Ö
  document.querySelectorAll("#promoGrid .promo-item").forEach(div => {
    const dev = div.querySelector("h4").textContent;
    order[dev] = {};
    div.querySelectorAll("input[type='number']").forEach(inp => {
      if (inp.value > 0) {
        const type = inp.id.split("_").slice(2).join("_");
        order[dev][type] = inp.value;
      }
    });
  });

  // –∑–±—ñ—Ä –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤
  order["–ü–æ–¥–∞—Ä—É–Ω–∫–∏"] = {};
  document.querySelectorAll("#giftGrid .promo-item").forEach(div => {
    const gift = div.querySelector("h4").textContent;
    const qty = div.querySelector("input[type='number']").value;
    const comment = div.querySelector("textarea").value;
    if (qty > 0) {
      order["–ü–æ–¥–∞—Ä—É–Ω–∫–∏"][gift] = {quantity: qty, comment};
    }
  });

  // —Ñ–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
  let orderText = "";
  Object.keys(order).forEach(section => {
    orderText += `\n${section}:\n`;
    Object.keys(order[section]).forEach(item => {
      const val = order[section][item];
      if (typeof val === "object") {
        orderText += `- ${item}: ${val.quantity} (${val.comment})\n`;
      } else {
        orderText += `- ${item}: ${val}\n`;
      }
    });
  });

  const login = getLoginName();

  // --- —Ñ–æ—Ä–º—É—î–º–æ –º–∞—Å–∏–≤ –¥–ª—è Google Sheets ---
  const rows = [];
  Object.keys(order).forEach(section => {
    Object.keys(order[section]).forEach(item => {
      const val = order[section][item];
      rows.push({
        manager: login,
        type: section,
        name: item,
        quantity: typeof val === "object" ? val.quantity : val,
        comment: typeof val === "object" ? val.comment : ""
      });
    });
  });

  // –æ–¥–∏–Ω –∑–∞–ø–∏—Ç –Ω–∞ –≤—Å—ñ —Ä—è–¥–∫–∏
  fetch("https://script.google.com/macros/s/AKfycby_-OwpYYAjDpKh0FkKio6fkD_pENWescMSnWyInx4orD8mkXkQegKNVAT8jsxfVt2W/exec", {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(rows)
  })
  .then(r => r.text())
  .then(txt => console.log("–ó–∞–ø–∏—Å–∞–Ω–æ —É Sheets:", txt))
  .catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É:", err));

  // --- —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –ª–∏—Å—Ç–∞ ---
  const now = new Date();
  const monthNames = [
    "—Å—ñ—á–µ–Ω—å","–ª—é—Ç–∏–π","–±–µ—Ä–µ–∑–µ–Ω—å","–∫–≤—ñ—Ç–µ–Ω—å","—Ç—Ä–∞–≤–µ–Ω—å","—á–µ—Ä–≤–µ–Ω—å",
    "–ª–∏–ø–µ–Ω—å","—Å–µ—Ä–ø–µ–Ω—å","–≤–µ—Ä–µ—Å–µ–Ω—å","–∂–æ–≤—Ç–µ–Ω—å","–ª–∏—Å—Ç–æ–ø–∞–¥","–≥—Ä—É–¥–µ–Ω—å"
  ];
  const month = monthNames[now.getMonth()];
  const year = now.getFullYear();

  const mailBody = encodeURIComponent(
    `–î–æ–±—Ä–∏–π –¥–µ–Ω—å, —à–∞–Ω–æ–≤–Ω–∏–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–µ!\n` +
    `–ù–∞–¥—Å–∏–ª–∞—é –í–∞–º –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–º–æ –Ω–∞ ${month} ${year}.\n\n` +
    `${orderText}\n` +
    `–ó –ø–æ–≤–∞–≥–æ—é,\n${login} –º–µ–Ω–µ–¥–∂–µ—Ä`
  );

  const subject = encodeURIComponent(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–º–æ –¥–ª—è ${login}`);

  window.location.href = `mailto:oplevish66@gmail.com?subject=${subject}&body=${mailBody}`;
  closePromoModal();
}

</script>
</body>
</html>
