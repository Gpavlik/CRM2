<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #006400, #004d00);
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin-top: 30px; text-align: center; }
    .login-box, .dashboard {
      max-width: 500px; width: 90%;
      margin: 40px auto; padding: 25px;
      background: #008000; border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }
    input {
      width: 96%; padding: 10px; margin: 0 auto 15px auto;
      border: none; border-radius: 6px; font-size: 1rem;
    }
    button {
      width: 100%; padding: 12px; margin-top: 10px;
      background-color: #004d00; color: #ffffff;
      border: none; border-radius: 6px; font-size: 1rem;
      cursor: pointer; transition: background 0.3s ease;
    }
    button:hover { background-color: #003300; }
    .result { margin-top: 15px; font-size: 0.85rem; text-align: center; }
    .menu { display: flex; flex-direction: column; gap: 12px; }
    .menu button { background: #006400; }
  </style>
</head>
<body>
  <h1>üî¨ Parmasco CRM</h1>
<img src="./logo.svg" alt="logo" width="560">
  <!-- –í—Ö—ñ–¥ -->
  <div class="login-box" id="loginBox">
    
    <h2>–í—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É</h2>
    <input type="text" id="login" placeholder="–õ–æ–≥—ñ–Ω">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="authenticate()">–£–≤—ñ–π—Ç–∏</button>
    <div class="result" id="result"></div>
   
  </div>
 
  <!-- Dashboard -->
  <div class="dashboard" id="dashboard" style="display:none;">
    <h2>üëã –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</h2>
    <p id="userRole"></p>
    <div class="menu">
      <button type="button" onclick="fetchLabsAndVisits()">üåÖ –ü–æ—á–∞—Ç–∏ –¥–µ–Ω—å</button>
      <button onclick="goToCalendar()">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä</button>
      <button onclick="goToLabs()">üß™ –ü–µ—Ä–µ–ª—ñ–∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</button>
      <button type="button" onclick="createNewLab()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é</button>
      <button onclick="goToReport()">üìä –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∑–≤—ñ—Ç–∏</button>
      <button onclick="logout()">üö™ –í–∏–π—Ç–∏</button>
      <button type="button" onclick="pushLabsAndVisits()">üåá –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –¥–µ–Ω—å</button>
  </div>
  </div>
<img src="./ivd.png" alt="logo" width="560">
  <script>
  let currentUser = null;
  let token = null;

  async function authenticate() {
    const login = document.getElementById("login").value;
    const password = document.getElementById("password").value;

    const response = await fetch("https://nodejs-production-7176.up.railway.app/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ login, password })
    });

    const result = await response.json();

    if (response.status === 200) {
      currentUser = login;
      token = result.token;
      localStorage.setItem("token", token); // üîë –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞
      showDashboard(result.role);
    } else {
      document.getElementById("result").innerHTML =
        `<p style='color:red'>‚ùå ${result.error}</p>`;
    }
  }

  function showDashboard(role) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    document.getElementById("userRole").innerHTML =
      `‚úÖ –í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ <b>${role}</b>`;
  }

  function showLogin() {
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("loginBox").style.display = "block";
  }

  function isTokenValid(token) {
    try {
      const payload = JSON.parse(atob(token.split(".")[1]));
      return payload.exp * 1000 > Date.now();
    } catch {
      return false;
    }
  }

  // üîé –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
window.onload = async () => {
  const savedToken = localStorage.getItem("token");
  if (savedToken && isTokenValid(savedToken)) {
    try {
      const res = await fetch("https://nodejs-production-7176.up.railway.app/labs", {
        headers: { "Authorization": "Bearer " + savedToken }
      });

      if (res.status === 403) {
        showLogin();
      } else {
        // —Ç–æ–∫–µ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π ‚Üí –¥—ñ—Å—Ç–∞—î–º–æ payload –∑ —Ç–æ–∫–µ–Ω–∞
        const payload = JSON.parse(atob(savedToken.split(".")[1]));
        showDashboard(payload.role); // —Ä–æ–ª—å —ñ–∑ —Ç–æ–∫–µ–Ω–∞
      }
    } catch {
      showLogin();
    }
  } else {
    showLogin();
  }
};


  function goToLabs() {
    window.location.href = "./labcards/labs.html";
  }

  function goToLabCard() {
    sessionStorage.removeItem("editLabId");
    window.location.href = "./labcards/labcard.html";
  }

  function goToCalendar() {
    window.location.href = "./calendar/calendar.html";
  }

  function goToReport() {
    window.location.href = "./reports/index.html";
  }

  function logout() {
    currentUser = null;
    token = null;
    localStorage.removeItem("token"); // üóëÔ∏è –æ—á–∏—â–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞
    showLogin();
    document.getElementById("result").innerHTML = `<p>üö™ –í–∏ –≤–∏–π—à–ª–∏ —ñ–∑ —Å–∏—Å—Ç–µ–º–∏</p>`;
  }


// === db.js ===
// –ü—Ä–æ—Å—Ç–∏–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ IndexedDB


// —É—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –¥–∞–Ω–∏—Ö –ø–æ —Ä–µ–∞–≥–µ–Ω—Ç—É
function getLatestReagentsInfo(allOrders) {
  const latestInfo = {};
  for (const order of allOrders) {
    const { reagentName, lastOrderDate, lastOrderCount } = order;
    if (
      !latestInfo[reagentName] ||
      new Date(lastOrderDate) > new Date(latestInfo[reagentName].lastOrderDate)
    ) {
      latestInfo[reagentName] = { lastOrderDate, lastOrderCount };
    }
  }
  return latestInfo;
}

// —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è –∑ –±–µ–∫–µ–Ω–¥—É ‚Üí —É–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
function transformLabFromBackend(lab) {
  return {
    ...lab,
    devices: (lab.devices || []).map(d => {
      const reagentsOrders = (d.reagents || []).map(r => ({
        reagentName: r.name,
        lastOrderDate: r.date,
        lastOrderCount: r.quantity
      }));
      const reagentsInfo = getLatestReagentsInfo(reagentsOrders);

      return {
        ...d,
        reagentsOrders,
        reagentsInfo,
        analyses: d.analyses || {}
      };
    })
  };
}



const DB_NAME = "labsDB";
const DB_VERSION = 1;
const LABS_STORE = "labs";
const VISITS_STORE = "visits";

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(LABS_STORE)) {
        db.createObjectStore(LABS_STORE, { keyPath: "_id" });
      }
      if (!db.objectStoreNames.contains(VISITS_STORE)) {
        db.createObjectStore(VISITS_STORE, { keyPath: "_id" });
      }
    };

    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// –ó–±–µ—Ä–µ–≥—Ç–∏ –º–∞—Å–∏–≤ —É IndexedDB
async function saveToDB(storeName, dataArray) {
  const db = await openDB();
  const tx = db.transaction(storeName, "readwrite");
  const store = tx.objectStore(storeName);

  dataArray.forEach(item => store.put(item));

  return tx.complete;
}

// –ü—Ä–æ—á–∏—Ç–∞—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ –∑ IndexedDB
async function getAllFromDB(storeName) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(storeName, "readonly");
    const store = tx.objectStore(storeName);
    const request = store.getAll();

    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// –û—á–∏—Å—Ç–∏—Ç–∏ IndexedDB
async function clearDB(storeName) {
  const db = await openDB();
  const tx = db.transaction(storeName, "readwrite");
  tx.objectStore(storeName).clear();
  return tx.complete;
}
// –ü—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –¥–∞–Ω—ñ –∑ –±–µ–∫–µ–Ω–¥—É —ñ –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ IndexedDB
async function fetchLabsAndVisits() {
  const token = localStorage.getItem("token");
  try {
    const [labsRes, visitsRes] = await Promise.all([
      fetch("https://nodejs-production-7176.up.railway.app/labs", {
        headers: { "Authorization": "Bearer " + token }
      }),
      fetch("https://nodejs-production-7176.up.railway.app/visits", {
        headers: { "Authorization": "Bearer " + token }
      })
    ]);

    if (!labsRes.ok || !visitsRes.ok) {
      throw new Error("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –∑ –±–µ–∫–µ–Ω–¥—É");
    }

    const labsRaw = await labsRes.json();
    const visitsRaw = await visitsRes.json();

    // —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—î–º–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó —É –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ñ–æ—Ä–º–∞—Ç
    const labs = labsRaw.map(transformLabFromBackend);

    // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ IndexedDB
    await clearDB(LABS_STORE);
    await clearDB(VISITS_STORE);
    await saveToDB(LABS_STORE, labs);
    await saveToDB(VISITS_STORE, visitsRaw);

    alert(`‚úÖ –î–∞–Ω—ñ –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–æ: ${labs.length} –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π, ${visitsRaw.length} –≤—ñ–∑–∏—Ç—ñ–≤`);
    return { labs, visits: visitsRaw };
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ fetch:", err);
    alert("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –¥–∞–Ω—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
    return { labs: [], visits: [] };
  }
}

// –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏ –Ω–∞ –±–µ–∫–µ–Ω–¥
async function pushLabsAndVisits() {
  const token = localStorage.getItem("token");
  try {
    const labsUnified = await getAllFromDB(LABS_STORE);
    const visits = await getAllFromDB(VISITS_STORE);

    // —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—î–º–æ –Ω–∞–∑–∞–¥ —É —Ñ–æ—Ä–º–∞—Ç –±–µ–∫–µ–Ω–¥—É
    const labsForBackend = labsUnified.map(transformLabToBackend);

    await Promise.all([
      fetch("https://nodejs-production-7176.up.railway.app/labs", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(labsForBackend)
      }),
      fetch("https://nodejs-production-7176.up.railway.app/visits", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(visits)
      })
    ]);

    alert("üåá –ó–º—ñ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –∑ –±–µ–∫–µ–Ω–¥–æ–º!");
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ push:", err);
    alert("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–º—ñ–Ω–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
  }
}
// === resetAndFetchDB.js ===
// –û—á–∏—Å—Ç–∏—Ç–∏ IndexedDB —ñ –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –Ω–æ–≤—ñ –¥–∞–Ω—ñ

async function resetAndFetchDB() {
  try {
    // 1. –û—á–∏—Å—Ç–∫–∞ IndexedDB
    await clearDB("labs");
    await clearDB("visits");
    console.log("üßπ IndexedDB –æ—á–∏—â–µ–Ω–æ");

    // 2. –ü—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
    const { labs, visits } = await fetchLabsAndVisits();

    console.log("‚úÖ –ù–æ–≤—ñ –¥–∞–Ω—ñ –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–æ:", labs.length, "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π,", visits.length, "–≤—ñ–∑–∏—Ç—ñ–≤");
    return { labs, visits };
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ —É resetAndFetchDB:", err);
    alert("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ IndexedDB. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
    return { labs: [], visits: [] };
  }
}


function createNewLab() {
  // –æ—á–∏—â–∞—î–º–æ –º–∞—Ä–∫–µ—Ä –ø–æ—Ç–æ—á–Ω–æ—ó –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó
  localStorage.removeItem("currentLabEdrpou");

  // –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∫–∞—Ä—Ç–∫–∏
  window.location.href = "labcard.html";
}
// === reset.js ===
// –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à —ñ –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –Ω–æ–≤—ñ –¥–∞–Ω—ñ


</script>

</body>
</html>
