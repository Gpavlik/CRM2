<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>üß™ –ú–æ—ó –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    h2 { text-align: center; }
    .lab-card {
      background: #fff; padding: 15px; margin: 10px 0;
      border-left: 4px solid #0077cc; border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .lab-card h3 { margin: 0 0 5px; }
    .lab-card ul { margin: 5px 0 0 15px; padding: 0; }
    .lab-card li { font-size: 14px; margin-bottom: 10px; }
    .actions { margin-top: 10px; }
    button {
      background: #0077cc; color: white; border: none;
      padding: 5px 10px; border-radius: 4px; cursor: pointer;
      margin-right: 5px;
    }
    button:hover { background: #005fa3; }
    .add-btn {
      display: inline-block; margin: 20px 0;
      background: #25a72b; color: white; padding: 10px 15px;
      text-decoration: none; border-radius: 5px;
    }
    .modal {
      position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
      background: #fff; padding: 20px; border: 2px solid #333;
      box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999;
      max-width: 500px;
    }
    .modal textarea { width: 100%; height: 200px; }
  </style>
</head>
<body>
  <h2>üß™ –ú–æ—ó –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó</h2>

  <div id="filters">
    <input list="partnerList" id="filterName" placeholder="–ù–∞–∑–≤–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó">
    <datalist id="partnerList"></datalist>
    <input list="regionList" id="filterRegion" placeholder="–û–±–ª–∞—Å—Ç—å">
    <datalist id="regionList"></datalist>
    <input list="cityList" id="filterCity" placeholder="–ú—ñ—Å—Ç–æ">
    <datalist id="cityList"></datalist>
    <input list="institutionList" id="filterInstitution" placeholder="–õ–ü–ó">
    <datalist id="institutionList"></datalist>
    <input list="deviceList" id="filterDevice" placeholder="–ü—Ä–∏–ª–∞–¥">
    <datalist id="deviceList"></datalist>
    <input list="contractorList" id="filterContractor" placeholder="–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç">
    <datalist id="contractorList"></datalist>
    <input list="phoneList" id="filterPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
    <datalist id="phoneList"></datalist>
    <button onclick="applyFilters()">üîç –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
    <button onclick="resetFilters()">‚ôªÔ∏è –°–∫–∏–Ω—É—Ç–∏</button>
    <button onclick="generateSmartCalendarTasks()">üìÖ –†–æ–∑—É–º–Ω–µ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –∑–∞–¥–∞—á</button>
    <button onclick="showCalendarTasks()">üóìÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∑–∞–¥–∞—á—ñ</button>
    <a href="./labcard.html" class="add-btn">‚ûï –î–æ–¥–∞—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é</a>
  </div>
  <a href="../calendar/calendar.html">
  <button>üìÖ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∑–∞–¥–∞—á</button>
</a>
 <a href="../index.html">
  <button> –ù–∞–∑–∞–¥</button>
</a>
  <div id="labList"></div>

  <script>
  let labCards = JSON.parse(localStorage.getItem("labCards") || "[]");

  const uniqueValues = {
    partner: new Set(), region: new Set(), city: new Set(),
    institution: new Set(), device: new Set(),
    contractor: new Set(), phone: new Set()
  };

  function fillAutocompleteLists() {
    Object.entries(uniqueValues).forEach(([key, set]) => {
      const datalist = document.getElementById(`${key}List`);
      if (!datalist) return;
      datalist.innerHTML = '';
      Array.from(set).sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        datalist.appendChild(option);
      });
    });
  }

  function deleteLab(index) {
    const confirmed = confirm(`‚ùó –í–∏ —Ç–æ—á–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é "${labCards[index].partner}"?`);
    if (confirmed) {
      labCards.splice(index, 1);
      localStorage.setItem("labCards", JSON.stringify(labCards));
      generateSmartCalendarTasks(); // üîÅ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ –∑–∞–¥–∞—á—ñ
      renderLabCards(labCards);
    }
  }

  function renderLabCards(filteredLabs) {
    const container = document.getElementById("labList");
    container.innerHTML = '';
    if (filteredLabs.length === 0) {
      container.innerHTML = "<p>‚ö†Ô∏è –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–¥–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏.</p>";
      return;
    }

    filteredLabs.forEach((lab, index) => {
      uniqueValues.partner.add(lab.partner);
      uniqueValues.contractor.add(lab.contractor || "");
      uniqueValues.region.add(lab.region);
      uniqueValues.city.add(lab.city);
      uniqueValues.institution.add(lab.institution);
      uniqueValues.phone.add(lab.phone || "");
      lab.devices.forEach(d => uniqueValues.device.add(d.device));

      const div = document.createElement("div");
      div.className = "lab-card";
      div.innerHTML = `
        <h3>${index + 1}. ${lab.partner}</h3>
        <button onclick="deleteLab(${index})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é</button>
        <p>üìç ${lab.region}, ${lab.city}</p>
        <p>üè• ${lab.institution}</p>
        <p>ü§ù –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: ${lab.contractor || "‚Äî"}</p>
        <p>üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${lab.phone || "‚Äî"}</p>
        <ul>
          ${lab.devices.map((d, i) => `
            <li>
              üîß <strong>${d.device}</strong><br>
              üìÖ –ü—Ä–æ–¥–∞–Ω–æ: ${d.soldDate || "‚Äî"}<br>
              üõ†Ô∏è –°–µ—Ä–≤—ñ—Å: ${d.lastService || "‚Äî"}<br>
              üîß –ó–∞–º—ñ–Ω–µ–Ω—ñ –¥–µ—Ç–∞–ª—ñ: ${d.replacedParts || "‚Äî"}<br>
              üì¶ –ó–∞–∫—É–ø—ñ–≤–ª—è —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤: ${d.reagentDate || "‚Äî"}
            </li>
          `).join("")}
        </ul>
      `;
      container.appendChild(div);
    });

    const calendarBtn = document.createElement("a");
    calendarBtn.href = "../calendar/calendar.html";
    calendarBtn.innerHTML = `<button style="margin-top: 20px;">üìÖ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∑–∞–¥–∞—á</button>`;
    container.appendChild(calendarBtn);
  }

  function applyFilters() {
    const name = document.getElementById("filterName").value.toLowerCase();
    const region = document.getElementById("filterRegion").value.toLowerCase();
    const city = document.getElementById("filterCity").value.toLowerCase();
    const institution = document.getElementById("filterInstitution").value.toLowerCase();
    const device = document.getElementById("filterDevice").value.toLowerCase();
    const contractor = document.getElementById("filterContractor").value.toLowerCase();
    const phone = document.getElementById("filterPhone").value.toLowerCase();

    const filtered = labCards.filter(lab => {
      return (
        (!name || lab.partner.toLowerCase().includes(name)) &&
        (!region || lab.region.toLowerCase().includes(region)) &&
        (!city || lab.city.toLowerCase().includes(city)) &&
        (!institution || lab.institution.toLowerCase().includes(institution)) &&
        (!device || lab.devices.some(d => d.device.toLowerCase().includes(device))) &&
        (!contractor || lab.contractor?.toLowerCase().includes(contractor)) &&
        (!phone || lab.phone.toLowerCase().includes(phone))
      );
    });

    renderLabCards(filtered);
    fillAutocompleteLists();
  }

  function resetFilters() {
    [
      "filterName","filterRegion","filterCity",
      "filterInstitution","filterDevice",
      "filterContractor","filterPhone"
    ].forEach(id => document.getElementById(id).value = '');
    renderLabCards(labCards);
    fillAutocompleteLists();
  }

  function generateSmartCalendarTasks() {
    const taskSchedule = {};
    const tasks = [];
    const today = new Date();
    const oneYearLater = new Date(today);
    oneYearLater.setFullYear(today.getFullYear() + 1);

    const labsByCity = {};
    labCards.forEach(lab => {
      if (!labsByCity[lab.city]) labsByCity[lab.city] = [];
      labsByCity[lab.city].push(lab);
    });

    Object.entries(labsByCity).forEach(([city, labs]) => {
      labs.forEach(lab => {
        const { partner, region } = lab;

        lab.devices.forEach(device => {
          const { device: deviceName, lastService, reagentDate } = device;

          if (lastService) {
            let date = new Date(lastService);
            while (date < oneYearLater) {
              const scheduledDate = findAvailableDate(date, taskSchedule);
              const task = {
                type: "service",
                title: `üîß –°–µ—Ä–≤—ñ—Å: ${deviceName}`,
                description: `–°–µ—Ä–≤—ñ—Å –ø—Ä–∏–ª–∞–¥—É ${deviceName} (${partner}, ${city})`,
                date: scheduledDate,
                device: deviceName,
                lab: partner,
                region,
                city,
                status: "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ"
              };
              tasks.push(task);
              taskSchedule[scheduledDate] = taskSchedule[scheduledDate] || [];
              taskSchedule[scheduledDate].push(task);
              date.setMonth(date.getMonth() + 6);
            }
          }

          if (reagentDate) {
            let date = new Date(reagentDate);
            while (date < oneYearLater) {
              const scheduledDate = findAvailableDate(date, taskSchedule);
              const task = {
                type: "reagents",
                title: `üì¶ –ó–∞–∫—É–ø—ñ–≤–ª—è: ${deviceName}`,
                description: `–ó–∞–∫—É–ø–∏—Ç–∏ —Ä–µ–∞–≥–µ–Ω—Ç–∏ –¥–ª—è ${deviceName} (${partner}, ${city})`,
                date: scheduledDate,
                device: deviceName,
                lab: partner,
                region,
                city,
                status: "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ"
              };
              tasks.push(task);
              taskSchedule[scheduledDate] = taskSchedule[scheduledDate] || [];
              taskSchedule[scheduledDate].push(task);
              date.setMonth(date.getMonth() + 3);
            }
          }
        });
      });
    });

    localStorage.setItem("calendarTasks", JSON.stringify(tasks));
  }

  function showCalendarTasks() {
    const tasks = JSON.parse(localStorage.getItem("calendarTasks") || "[]");
    const modal = document.createElement("div");
    modal.className = "modal";
    modal.innerHTML = `
      <h3>üóìÔ∏è –ó–∞–¥–∞—á—ñ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</h3>
      <ul>
        ${tasks.map(t => `<li><strong>${t.date}</strong>: ${t.title} ‚Äî ${t.description}</li>`).join("")}
      </ul>
      <button onclick="this.closest('.modal').remove()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
    `;
    document.body.appendChild(modal);
  }

  function findAvailableDate(startDate, taskSchedule) {
    let date = new Date(startDate);
    while (true) {
      const iso = date.toISOString().split("T")[0];
      const count = taskSchedule[iso]?.length || 0;
      if (count < 6 && ![0, 6].includes(date.getDay())) return iso;
      date.setDate(date.getDate() + 1);
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    renderLabCards(labCards);
    fillAutocompleteLists();
    generateSmartCalendarTasks(); // üîÅ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
  });
</script>
</body> 
</html>