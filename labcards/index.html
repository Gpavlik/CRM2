<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>üß™ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    h2 { margin-bottom: 20px; }
    label { display: inline-block; margin: 10px 10px 0 0; font-weight: bold; }
    input { padding: 6px; margin-top: 5px; }
    button { margin: 5px; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { opacity: 0.9; }

    .lab-card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #fff;
    }

    .lab-actions {
      margin: 10px 0;
    }

    .lab-actions button {
      margin-right: 8px;
    }

    .lab-actions button:first-child {
      background: #4caf50;
      color: white;
    }

    .lab-actions button:last-child {
      background: #f44336;
      color: white;
    }

    .priority-red { color: #f44336; font-weight: bold; }
    .priority-yellow { color: #ff9800; font-weight: bold; }
    .priority-green { color: #4caf50; font-weight: bold; }

    .task-list ul {
      margin-left: 20px;
      list-style-type: disc;
    }

    .filter-bar {
      margin-bottom: 20px;
      padding: 10px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>üß™ –°–ø–∏—Å–æ–∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</h2>

  <!-- –ü–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
  <div class="filter-bar">
    <label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:
      <input type="text" id="filterName" list="partnerList">
      <datalist id="partnerList"></datalist>
    </label>
    <label>–û–±–ª–∞—Å—Ç—å:
      <input type="text" id="filterRegion" list="regionList">
      <datalist id="regionList"></datalist>
    </label>
    <label>–ú—ñ—Å—Ç–æ:
      <input type="text" id="filterCity" list="cityList">
      <datalist id="cityList"></datalist>
    </label>
    <label>–õ–ü–ó:
      <input type="text" id="filterInstitution" list="institutionList">
      <datalist id="institutionList"></datalist>
    </label>
    <label>–ü—Ä–∏–ª–∞–¥:
      <input type="text" id="filterDevice" list="deviceList">
      <datalist id="deviceList"></datalist>
    </label>
    <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞:
      <input type="text" id="filterContractor" list="contractorList">
      <datalist id="contractorList"></datalist>
    </label>
    <label>–¢–µ–ª–µ—Ñ–æ–Ω:
      <input type="text" id="filterPhone" list="phoneList">
      <datalist id="phoneList"></datalist>
    </label>
    <label>–Ñ–î–†–ü–û–£:
      <input type="text" id="filterEdrpou" list="edrpouList">
      <datalist id="edrpouList"></datalist>
    </label>
    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:
      <input type="text" id="filterManager" list="managerList">
      <datalist id="managerList"></datalist>
    </label>
    <br>
    <button onclick="applyFilters()">üîç –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
    <button onclick="resetFilters()">‚ôªÔ∏è –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
    <a href="./labcard.html"><button>‚ûï –î–æ–¥–∞—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é</button></a>
    <button onclick="planAllVisits()">üìÖ –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ –≤—Å—ñ –≤—ñ–∑–∏—Ç–∏</button>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π -->
  <div id="labList"></div>
<script src="./logistics.js"></script>
  <script src="./labcards.js"></script>
  <script src="../shared/Calendar.js"></script>

  <script>
    window.onload = () => {
      const labCards = JSON.parse(localStorage.getItem("labCards") || "[]");
      renderLabCards(labCards);
    };

    function renderLabCards(labs) {
      const container = document.getElementById("labList");
      container.innerHTML = "";

      if (!labs.length) {
        container.innerHTML = "<p>‚ö†Ô∏è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>";
        return;
      }

      labs.forEach((lab, index) => {
        const card = document.createElement("div");
        card.className = "lab-card";
        card.innerHTML = `
          <h3>${index + 1}. ${lab.partner} (${lab.city})</h3>
          <p>üè• ${lab.institution}</p>
          <p>üìü –ü—Ä–∏–ª–∞–¥–∏: ${lab.devices.map(d => d.device).join(", ")}</p>
          <p>ü§ù –ö–æ–Ω—Ç–∞–∫—Ç: ${lab.contractor || "‚Äî"} üìû ${lab.phone || "‚Äî"}</p>
          <p>üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä: ${lab.manager || "‚Äî"}</p>
          <div class="lab-actions">
            <button onclick="editLabCard(${index})">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
            <button onclick="deleteLab(${index})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
            <button onclick="createVisit('${lab.id}')">üìÖ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–∑–∏—Ç</button>
          </div>
          ${lab.tasks?.length ? `
            <h4>üóìÔ∏è –ü—Ä–µ–≤‚Äô—é –∑–∞–¥–∞—á:</h4>
            <ul class="task-list">
              ${lab.tasks.map(task => {
                const taskDate = new Date(task.date);
                const today = new Date();
                const urgentThreshold = new Date();
                urgentThreshold.setDate(today.getDate() + 7);

                let priorityClass = "priority-green";
                if (taskDate < today) priorityClass = "priority-red";
                else if (taskDate <= urgentThreshold) priorityClass = "priority-yellow";

                const subtasks = task.tasks?.map(sub => `<li>${sub.priority} ${sub.action} (${sub.device})</li>`).join("");

                return `
                  <li class="${priorityClass}">
                    <strong>${task.date}</strong>: ${task.title}
                    ${subtasks ? `<ul>${subtasks}</ul>` : ""}
                  </li>
                `;
              }).join("")}
            </ul>
          ` : ""}
        `;
        container.appendChild(card);
      });
    }

    async function createVisit(labId) {
      const visitDate = sessionStorage.getItem("visitDate");
      if (!visitDate) {
        alert("‚ö†Ô∏è –î–∞—Ç–∞ –≤—ñ–∑–∏—Ç—É –Ω–µ –∑–∞–¥–∞–Ω–∞. –ü–µ—Ä–µ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä.");
        return;
      }

      const labCards = JSON.parse(localStorage.getItem("labCards") || "[]");
      const lab = labCards.find(l => l.id === labId);
      if (!lab) return;

      const tasks = await generateDeviceTasksWithDueDates(lab);

      const visit = {
        labId,
        date: visitDate,
        tasks
      };

      sessionStorage.setItem("newVisit", JSON.stringify(visit));
      window.location.href = "../calendar.html";
    }

    async function planAllVisits() {
      await processVisitReport([]); // –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –±–µ–∑ –∑–≤—ñ—Ç—ñ–≤
      window.location.href = "../calendar.html"; // –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    }
  </script>
</body>
</html>
