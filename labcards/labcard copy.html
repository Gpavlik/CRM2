<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞—Ä—Ç–∫–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #006400, #004d00);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin-top: 30px; }
    form {
      max-width: 900px;
      width: 95%;
      margin: 20px auto;
      padding: 20px;
      background: #008000;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }
    form label { display: block; margin: 12px 0; }
    input {
      width: 100%; padding: 8px;
      border-radius: 6px; border: none;
    }
    .form-actions { margin-top: 20px; }
    .form-actions button {
      margin-right: 10px;
      background: #006400; color: white;
      border: none; cursor: pointer;
      padding: 10px 14px; border-radius: 6px;
    }
    .form-actions button:hover { background: #003300; }
    .device-block {
      border: 1px solid #ccc; padding: 10px;
      margin-bottom: 12px; background: #fff;
      border-radius: 6px; color: #000;
    }
  </style>
</head>
<body>
  <img src="../logo.svg" alt="logo" width="220">
  <h1>üß™ –ö–∞—Ä—Ç–∫–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó</h1>

  <form id="labForm">
    <label>–ù–∞–∑–≤–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞: <input type="text" id="partnerName" autocomplete="organization" required></label>
    <label>–û–±–ª–∞—Å—Ç—å: <input type="text" id="region" autocomplete="address-level1"></label>
    <label>–ú—ñ—Å—Ç–æ: <input type="text" id="city" autocomplete="address-level2"></label>
    <label>–õ–ü–ó: <input type="text" id="lpz" autocomplete="organization"></label>
    <label>–ê–¥—Ä–µ—Å–∞: <input type="text" id="labAddress" autocomplete="street-address"></label>
    <label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (–æ—Å–æ–±–∞): <input type="text" id="contractor" autocomplete="name"></label>
    <label>–¢–µ–ª–µ—Ñ–æ–Ω: <input type="text" id="phone" autocomplete="tel"></label>
    <label>–Ñ–î–†–ü–û–£: <input type="text" id="labEdrpou" autocomplete="off" required></label>
    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä: <input type="text" id="labManager" autocomplete="name"></label>

    <section id="devicesSection" style="display:none;">
      <h2>üîß –ü—Ä–∏–ª–∞–¥–∏</h2>
      <div id="devicesContainer"></div>
    </section>

    <!-- –ù–û–í–ò–ô –±–ª–æ–∫ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ—ó –¥–∞—Ç–∏ -->
    <h2>üìÖ –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –≤—ñ–∑–∏—Ç—É</h2>
    <label>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –¥–∞—Ç–∞ –≤—ñ–∑–∏—Ç—É:
      <input type="date" id="recommendedVisitDate">
    </label>
    <button type="button" onclick="suggestVisitDate()">üìÖ –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –¥–∞—Ç—É</button>

    <div class="form-actions">
      <button type="button" onclick="saveLabCard()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button type="button" onclick="updateLabCard()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
      <a href="./labs.html"><button type="button">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button></a>
    </div>
  </form>

  <!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ logistics.js -->
  <script src="logistics.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const edrpou = sessionStorage.getItem("editLabEdrpou");
      if (!edrpou) {
        console.log("‚ÑπÔ∏è –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó");
        return;
      }

      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`https://nodejs-production-7176.up.railway.app/labs/${edrpou}`, {
          headers: { "Authorization": "Bearer " + token }
        });
        if (res.ok) {
          const lab = await res.json();
          fillForm(lab);
        } else {
          if (window.labsCache) {
            const lab = window.labsCache.find(l => l.edrpou === edrpou);
            if (lab) fillForm(lab);
            else alert("‚ùå –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
          } else {
            alert("‚ùå –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
          }
        }
      } catch (err) {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: " + err.message);
      }
    });

    function fillForm(lab) {
      document.getElementById("partnerName").value = lab.partner || "";
      document.getElementById("region").value = lab.region || "";
      document.getElementById("city").value = lab.city || "";
      document.getElementById("lpz").value = lab.institution || "";
      document.getElementById("labAddress").value = lab.address || "";
      document.getElementById("contractor").value = lab.contractor || "";
      document.getElementById("phone").value = lab.phone || "";
      document.getElementById("labEdrpou").value = lab.edrpou || "";
      document.getElementById("labManager").value = lab.manager || "";

      if (lab.devices && lab.devices.length > 0) {
        document.getElementById("devicesSection").style.display = "block";
        const container = document.getElementById("devicesContainer");
        container.innerHTML = "";
        lab.devices.forEach(d => {
          const div = document.createElement("div");
          div.className = "device-block";
          div.innerHTML = `<p><b>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</b> ${d.category || "‚Äî"}</p><p><b>–ü—Ä–∏–ª–∞–¥:</b> ${d.device || "‚Äî"}</p>`;
          container.appendChild(div);
        });
      }
    }

    async function saveLabCard() {
      const lab = getFormData();
      const token = localStorage.getItem("token");
      try {
        const res = await fetch("https://nodejs-production-7176.up.railway.app/labs", {
          method: "POST",
          headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
          body: JSON.stringify(lab)
        });
        if (res.ok) {
          alert("‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ");
          window.location.href = "./labs.html";
        } else {
          alert("‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è");
        }
      } catch (err) {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + err.message);
      }
    }

    async function updateLabCard() {
      const edrpou = sessionStorage.getItem("editLabEdrpou");
      if (!edrpou) {
        alert("‚ö†Ô∏è –ù–µ–º–∞—î –Ñ–î–†–ü–û–£ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è");
        return;
      }
      const lab = getFormData();
      const token = localStorage.getItem("token");
      try {
        const res = await fetch(`https://nodejs-production-7176.up.railway.app/labs/${edrpou}`, {
          method: "PATCH",
          headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
          body: JSON.stringify(lab)
        });
        if (res.ok) {
          alert("‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é –æ–Ω–æ–≤–ª–µ–Ω–æ");
          window.location.href = "./labs.html";
        } else {
          alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è");
        }
      } catch (err) {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + err.message);
      }
    }

    function getFormData() {
  return {
    partner: document.getElementById("partnerName").value.trim(),
    region: document.getElementById("region").value.trim(),
    city: document.getElementById("city").value.trim(),
    institution: document.getElementById("lpz").value.trim(),
    address: document.getElementById("labAddress").value.trim(),
    contractor: document.getElementById("contractor").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    edrpou: document.getElementById("labEdrpou").value.trim(),
    manager: document.getElementById("labManager").value.trim(),

    // üîß –ü—Ä–∏–ª–∞–¥–∏ ‚Äî –ø–æ–∫–∏ —â–æ –ø—É—Å—Ç–∏–π –º–∞—Å–∏–≤, –∞–ª–µ –º–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏
    devices: collectDevices(),

    // üìÖ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –¥–∞—Ç–∞ –≤—ñ–∑–∏—Ç—É (—è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ "–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –¥–∞—Ç—É")
    recommendedVisitDate: document.getElementById("recommendedVisitDate").value || null
  };
}

// –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–±–æ—Ä—É –ø—Ä–∏–ª–∞–¥—ñ–≤ –∑ devicesSection
function collectDevices() {
  const container = document.getElementById("devicesContainer");
  if (!container) return [];

  const blocks = container.querySelectorAll(".device-block");
  const devices = [];
  blocks.forEach(block => {
    const category = block.querySelector(".device-category")?.value || "";
    const device = block.querySelector(".device-name")?.value || "";
    if (category || device) {
      devices.push({ category, device });
    }
  });
  return devices;
}
    function suggestVisitDate() {
      const today = new Date();
      const suggestedDate = new Date(today);
      suggestedDate.setDate(today.getDate() + 7); // –ü—Ä–æ–ø–æ–Ω—É—î–º–æ –¥–∞—Ç—É —á–µ—Ä–µ–∑ —Ç–∏–∂–¥–µ–Ω—å
      const yyyy = suggestedDate.getFullYear();
      const mm = String(suggestedDate.getMonth() + 1).padStart(2, '0');
      const dd = String(suggestedDate.getDate()).padStart(2, '0');
      document.getElementById("recommendedVisitDate").value = `${yyyy}-${mm}-${dd}`;
    }
  </script>             
</body>
</html>
