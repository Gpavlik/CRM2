<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–ø–∏—Å–æ–∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="logistics.js"></script> <!-- —Ç–≤—ñ–π —Ñ–∞–π–ª -->  

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #006400, #004d00);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin-top: 30px; }
    .dashboard {
      max-width: 1200px;
      width: 95%;
      margin: 20px auto;
      padding: 20px;
      background: #008000;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }
    .lab-card {
      background: #fff;
      color: #000;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .lab-actions { margin-top: 8px; }
    button {
      margin: 4px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #006400;
      color: #fff;
    }
    button:hover { background-color: #003300; }
    input, select {
      width: 96%;
      padding: 6px;
      border-radius: 4px;
      border: none;
    }
    #filters {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 95%;
      margin: 20px auto;
    }
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
    }
    .filters-row label {
      flex: 1 1 20%;
      min-width: 180px;
      background: #004d00;
      padding: 6px;
      border-radius: 6px;
    }
    #pagination { margin-top: 20px; text-align: center; }
    #pagination button { margin: 4px; }
#purchasesTable {
  width: 100%;
  border-collapse: collapse;
}

#purchasesTable th,
#purchasesTable td {
  border: 1px solid white;   /* –±—ñ–ª—ñ –ª—ñ–Ω—ñ—ó */
  padding: 8px;
  text-align: left;
}

#purchasesTable th {
  background-color: #333;    /* —Ç–µ–º–Ω–∏–π —Ñ–æ–Ω –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ */
  color: white;
}

#purchasesTable tr:hover {
  background-color: #45ff8391; /* –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Ä—è–¥–∫—ñ–≤ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
} 
.lab-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.lab-actions button {
  flex: 1;
  padding: 6px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.3s ease;
}

.lab-actions button:nth-child(1) { background: #009933; color: #fff; } /* —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ */
.lab-actions button:nth-child(2) { background: #cc0000; color: #fff; } /* –≤–∏–¥–∞–ª–∏—Ç–∏ */
.lab-actions button:nth-child(3) { background: #0066cc ; color: #fff; } /* —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–∑–∏—Ç */

.lab-actions button:hover { opacity: 0.85; }

  </style>
</head>
<body>
  
  <img src="../logo.svg" alt="logo" width="220">
  <h1 style="text-align: center;">üìã –°–ø–∏—Å–æ–∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π</h1>

  <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
  <section id="filters">
    <div class="filters-row">
      <label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:
        <input type="text" id="filterPartner" list="partnerOptions">
        <datalist id="partnerOptions"></datalist>
      </label>
      <span id="managerFilterContainer"></span>
      <label>–û–±–ª–∞—Å—Ç—å: 
        <input type="text" id="filterRegion" list="regionOptions">
        <datalist id="regionOptions"></datalist>
      </label>
      <label>–ú—ñ—Å—Ç–æ:
        <input type="text" id="filterCity" list="cityOptions">
        <datalist id="cityOptions"></datalist>
      </label>
      <label>–õ–ü–ó:
        <input type="text" id="filterInstitution" list="institutionOptions">
        <datalist id="institutionOptions"></datalist>
      </label>
      <label>–ü—Ä–∏–ª–∞–¥:
        <input type="text" id="filterDevice" list="deviceOptions">
        <datalist id="deviceOptions"></datalist>
      </label>
      <label>–ö–ü:
        <input type="text" id="filterKp" list="kpOptions">
        <datalist id="kpOptions"></datalist>
      </label>
      <label>–Ñ–î–†–ü–û–£:
        <input type="text" id="filterEdrpou" list="edrpouOptions">
        <datalist id="edrpouOptions"></datalist>
      </label>
    </div>
    <div>
      <label>–ü—Ä–∏–ª–∞–¥–∏: 
        <select id="filterDevices"> 
          <option value="all">–£—Å—ñ</option> 
          <option value="with">–ó –ø—Ä–∏–ª–∞–¥–∞–º–∏</option> 
          <option value="without">–ë–µ–∑ –ø—Ä–∏–ª–∞–¥—ñ–≤</option>
        </select>
      </label>
      <button type="button" onclick="applyFilters()">üîç –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
      <button type="button" onclick="resetFilters()">‚ôªÔ∏è –°–∫–∏–Ω—É—Ç–∏</button>
      <button onclick="exportToExcel()">‚¨áÔ∏è –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
      <a href="../calendar/calendar.html"><button>üìÖ –î–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</button></a>
      <button onclick="createNewLab()">‚ûï –î–æ–¥–∞—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é</button>
      <a href="../index.html"><button>üè† –ù–∞–∑–∞–¥</button></a>
    </div>
  </section>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ–∫ -->
  <div id="labsContainer" class="dashboard"></div>

  <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
  <div id="pagination"></div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–∑–∏—Ç—É -->
<div id="createVisitModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); 
     background:#fff; color:#000; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.6); 
     padding:20px; z-index:1000; width:300px;">
  <span class="close" onclick="closeCreateVisitModal()" 
        style="float:right; cursor:pointer; font-size:20px;">&times;</span>
  <h3>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–∑–∏—Ç—É</h3>
  <label>–î–∞—Ç–∞: <input type="date" id="visitDate"></label><br><br>
  <label>–ß–∞—Å: <input type="time" id="visitTime"></label><br><br>
  <button onclick="confirmCreateVisit()">‚úÖ –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
  <button onclick="closeCreateVisitModal()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
</div>


  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <div>
    <button onclick="createNewLab()">‚ûï –î–æ–¥–∞—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é</button>
    <a href="../index.html"><button>üè† –ù–∞–∑–∞–¥</button></a>
  </div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–∞–ø–∏ -->
<div id="map" style="width:95%; height:500px; margin:20px auto; border-radius:12px;"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ -->
<div id="mapModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:70%; background:#fff; color:#000; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.6); overflow:auto; padding:20px; z-index:1000;">
  <h2>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó —É –≤–∏–¥—ñ–ª–µ–Ω—ñ–π –∑–æ–Ω—ñ</h2>
  <table id="modalTable" border="1" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
      <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th><th>–ú—ñ—Å—Ç–æ</th><th>–õ–ü–ó</th><th>–Ñ–î–†–ü–û–£</th><th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
</div>
<div id="purchasesModal" style="display:none;">
  <h2>–ó–∞–∫—É–ø—ñ–≤–ª—ñ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 90 –¥–Ω—ñ–≤</h2>
  <table id="purchasesTable">
    <thead>
      <tr>
        <th>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è</th>
        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
        <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
        <th>–î–∞—Ç–∞</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="downloadExcel()">‚¨áÔ∏è –í–∏–∫–∞—á–∞—Ç–∏ –≤ Excel</button>
  <button onclick="closePurchasesModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>


<script>
let labsData = [];
let filteredLabs = [];
let currentPage = 1;
const pageSize = 25;

let map;
let markersLayer;
let currentLabId = null;

// ==========================
// –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–∑–∏—Ç—É
// ==========================
function openCreateVisitModal(labId) {
  window.currentLabId = labId;
  document.getElementById("createVisitModal").style.display = "block";
}

function closeCreateVisitModal() {
  document.getElementById("createVisitModal").style.display = "none";
}

async function confirmCreateVisit() {
  const token = localStorage.getItem("token");
  const manager = localStorage.getItem("userLogin") || "–ù–µ–≤—ñ–¥–æ–º–æ";

  const date = document.getElementById("visitDate").value;
  const time = document.getElementById("visitTime").value;

  if (!date || !time) {
    alert("‚ùå –í–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É —Ç–∞ —á–∞—Å");
    return;
  }

  const fullDateTime = new Date(`${date}T${time}`);

  const newVisit = {
    labId: window.currentLabId,
    date: fullDateTime.toISOString(), // –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ ISO-—Ä—è–¥–æ–∫
    manager,
    status: "planned",
    notes: ""
  };

  try {
    const res = await fetch("https://nodejs-production-7176.up.railway.app/visits", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(newVisit)
    });

    if (res.ok) {
      alert("‚úÖ –í—ñ–∑–∏—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
      closeCreateVisitModal();
      window.location.href = "../calendar/calendar.html"; // –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    } else {
      const err = await res.json();
      alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –≤—ñ–∑–∏—Ç—É: " + (err.error || res.status));
    }
  } catch (e) {
    alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º");
  }
}

// ==========================
// –ú–∞–ø–∞ —Ç–∞ –∑–∞–∫—É–ø—ñ–≤–ª—ñ
// ==========================
function initMap() {
  if (map) return;
  map = L.map('map').setView([50.45, 30.52], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);
  const drawnItems = new L.FeatureGroup().addTo(map);

  const drawControl = new L.Control.Draw({
    draw: {
      polygon: true,
      rectangle: true,
      circle: false,
      marker: false,
      polyline: false
    },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED, async function (e) {
    const layer = e.layer;
    drawnItems.addLayer(layer);
    const bounds = layer.getBounds();
    const labsInArea = filterLabsByPolygon(bounds);
    const purchases = await fetchPurchases(labsInArea.map(l => l._id));
    console.log("üßæ –ó–∞–∫—É–ø—ñ–≤–ª—ñ:", purchases);
    openPurchasesModal(purchases);
  });
}

function filterLabsByPolygon(bounds) {
  return labsData.filter(lab => {
    if (!lab.lat || !lab.lng) return false;
    const point = L.latLng(lab.lat, lab.lng);
    return bounds.contains(point);
  });
}

async function fetchPurchases(labIds) {
  const token = localStorage.getItem("token");
  const res = await fetch("https://nodejs-production-7176.up.railway.app/purchases", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ labIds, days: 90 })
  });

  if (!res.ok) {
    console.error("‚ùå –ó–∞–ø–∏—Ç –Ω–µ —É—Å–ø—ñ—à–Ω–∏–π:", res.status);
    return [];
  }

  return await res.json();
}

function openPurchasesModal(purchases) {
  const tbody = document.querySelector("#purchasesTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";
  purchases.forEach(p => {
    const row = `
      <tr>
        <td>${p.labName || "‚Äî"}</td>
        <td>${p.item || "‚Äî"}</td>
        <td>${p.amount || "‚Äî"}</td>
        <td>${p.date !== "‚Äî" ? new Date(p.date).toLocaleDateString() : "‚Äî"}</td>
      </tr>
    `;
    tbody.innerHTML += row;
  });

  document.getElementById("purchasesModal").style.display = "block";
}

function closePurchasesModal() {
  document.getElementById("purchasesModal").style.display = "none";
}

// 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞–ø–∏
function updateMap(data) {
  if (!map) initMap();
  markersLayer.clearLayers();

  for (const lab of data) {
    if (!lab.lat || !lab.lng) continue;
    const marker = L.marker([lab.lat, lab.lng]).addTo(markersLayer);
    marker.bindPopup(`
      <b>${lab.partner || "‚Äî"}</b><br>
      ${lab.city || "‚Äî"}<br>
      –õ–ü–ó: ${lab.institution || "‚Äî"}<br>
      –Ñ–î–†–ü–û–£: ${lab.edrpou || "‚Äî"}
      <button onclick="editLab('${lab.edrpou}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
    `);
  }
}

// 3. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ–π
async function fetchLabs() {
  try {
    const token = localStorage.getItem("token");
    const res = await fetch("https://nodejs-production-7176.up.railway.app/labs", {
      headers: { "Authorization": "Bearer " + token }
    });
    labsData = await res.json();
    filteredLabs = labsData;

    showManagerFilterIfAllowed();
    populateFilterOptions(labsData);
    renderLabs(filteredLabs);
    updateMap(filteredLabs);
  } catch (err) {
    document.getElementById("labsContainer").innerHTML =
      "<p>‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó: " + err.message + "</p>";
  }
}

// 4. –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ–∫
function renderLabs(data = filteredLabs) {
  const container = document.getElementById("labsContainer");
  container.innerHTML = "";

  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  const labsPage = data.slice(start, end);

  labsPage.forEach(lab => {
    const devicesList = (lab.devices || [])
      .map(d => d.category || d.device)
      .filter(Boolean)
      .join(", ");

    const card = document.createElement("div");
    card.className = "lab-card";
    card.innerHTML = `
  <h3>${lab.partner || "‚Äî"}</h3>
  <p><b>–ú–µ–Ω–µ–¥–∂–µ—Ä:</b> ${lab.manager || "‚Äî"}</p>
  <p><b>–†–µ–≥—ñ–æ–Ω:</b> ${lab.region || "‚Äî"}</p>
  <p><b>–ú—ñ—Å—Ç–æ:</b> ${lab.city || "‚Äî"}</p>
  <p><b>–Ñ–î–†–ü–û–£:</b> ${lab.edrpou || "‚Äî"}</p>
  <p><b>–ü—Ä–∏–ª–∞–¥–∏:</b> ${devicesList || "‚Äî"}</p>
  <div class="lab-actions">
    <button onclick="editLab('${lab.edrpou}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
    <button onclick="deleteLab('${lab._id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
    <button onclick="openCreateVisitModal('${lab._id}')">üìÖ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–∑–∏—Ç</button>
  </div>
`;

    container.appendChild(card);
  });

  renderPagination(data);
}

function editLab(labEdrpou) {
  sessionStorage.setItem("editLabEdrpou", labEdrpou);
  window.location.href = "./labcard.html";
}


async function deleteLab(labId) {
  if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é?")) return;

  const token = localStorage.getItem("token");
  const res = await fetch(`https://nodejs-production-7176.up.railway.app/labs/${labId}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });

  if (res.ok) {
    alert("‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ");
    location.reload();
  } else {
    alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ");
  }
}


// 5. –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è
function renderPagination(data = filteredLabs) {
  const totalPages = Math.ceil(data.length / pageSize);
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === currentPage) btn.style.backgroundColor = "#003300";
    btn.onclick = () => { currentPage = i; renderLabs(data); };
    pagination.appendChild(btn);
  }
}

// 6. –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è
function applyFilters() {
  let filtered = labsData;

  const getVal = id => document.getElementById(id)?.value;

  const filters = {
    partner: getVal("filterPartner"),
    region: getVal("filterRegion"),
    city: getVal("filterCity"),
    institution: getVal("filterInstitution"),
    edrpou: getVal("filterEdrpou"),
    manager: getVal("filterManager"),
    deviceCategory: getVal("filterDevice"),
    deviceFilter: getVal("filterDevices")
  };

  if (filters.partner) filtered = filtered.filter(l => l.partner === filters.partner);
  if (filters.region) filtered = filtered.filter(l => l.region === filters.region);
  if (filters.city) filtered = filtered.filter(l => l.city === filters.city);
  if (filters.institution) filtered = filtered.filter(l => l.institution === filters.institution);
  if (filters.edrpou) filtered = filtered.filter(l => l.edrpou === filters.edrpou);
  if (filters.manager) filtered = filtered.filter(l => l.manager === filters.manager);
  if (filters.deviceCategory) {
    filtered = filtered.filter(l =>
      (l.devices || []).some(d => d.category === filters.deviceCategory || d.device === filters.deviceCategory)
    );
  }
  if (filters.deviceFilter === "with") {
    filtered = filtered.filter(l => l.devices && l.devices.length > 0);
  } else if (filters.deviceFilter === "without") {
    filtered = filtered.filter(l => !l.devices || l.devices.length === 0);
  }

  filteredLabs = filtered;
  currentPage = 1;
  renderLabs(filteredLabs);
  populateFilterOptions(filteredLabs);
  updateMap(filteredLabs);

  if (filteredLabs.length === 1) {
    const lab = filteredLabs[0];
    document.getElementById("filterPartner").value = lab.partner || "";
    document.getElementById("filterRegion").value = lab.region || "";
    document.getElementById("filterCity").value = lab.city || "";
    document.getElementById("filterInstitution").value = lab.institution || "";
    document.getElementById("filterEdrpou").value = lab.edrpou || "";
    if (document.getElementById("filterManager")) {
      document.getElementById("filterManager").value = lab.manager || "";
    }
  }
}

// 7. –ü—ñ–¥–∫–∞–∑–∫–∏
function populateFilterOptions(source = labsData) {
  const setOptions = (id, values) => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = [...new Set(values.filter(Boolean))]
      .map(v => `<option value="${v}">`).join("");
  };

  setOptions("partnerOptions", source.map(l => l.partner));
  setOptions("regionOptions", source.map(l => l.region));
  setOptions("cityOptions", source.map(l => l.city));
  setOptions("institutionOptions", source.map(l => l.institution));
  setOptions("edrpouOptions", source.map(l => l.edrpou));
  setOptions("managerOptions", source.map(l => l.manager));

  const deviceOptions = document.getElementById("deviceOptions");
  if (deviceOptions) {
    deviceOptions.innerHTML = "";
    const uniqueDevices = new Set();
    source.forEach(lab => (lab.devices || []).forEach(d => d.category && uniqueDevices.add(d.category)));
    uniqueDevices.forEach(val => {
      const option = document.createElement("option");
      option.value = val;
      deviceOptions.appendChild(option);
    });
  }

  const kpOptions = document.getElementById("kpOptions");
  if (kpOptions) {
    kpOptions.innerHTML = "";
    const uniqueKp = new Set();
    source.forEach(lab => (lab.devices || []).forEach(d => {
      if (d.kp) uniqueKp.add(d.kp);
    }));
    uniqueKp.forEach(val => {
      const option = document.createElement("option");
      option.value = val;
      kpOptions.appendChild(option);
    });
  }
}

// 8. –°–∫–∏–¥–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
function resetFilters() {
  document.querySelectorAll("#filters input, #filters select").forEach(el => el.value = "");
  document.getElementById("filterDevices").value = "all";
  filteredLabs = labsData;
  currentPage = 1;
  renderLabs(filteredLabs);
  populateFilterOptions(labsData);
  updateMap(filteredLabs);
}

// 9. –ú–µ–Ω–µ–¥–∂–µ—Ä-—Ñ—ñ–ª—å—Ç—Ä
function showManagerFilterIfAllowed() {
  const token = localStorage.getItem("token");
  if (!token) return;

  try {
    const payload = JSON.parse(atob(token.split(".")[1]));
    if (payload.role === "admin" || payload.role === "manager") {
      const container = document.getElementById("managerFilterContainer");
      container.innerHTML = `
        <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:
          <input type="text" id="filterManager" list="managerOptions">
          <datalist id="managerOptions"></datalist>
        </label>
      `;
      populateFilterOptions(labsData);
    } else {
      const container = document.getElementById("managerFilterContainer");
      if (container) container.innerHTML = "";
    }
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–±–æ—Ä—É —Ç–æ–∫–µ–Ω–∞:", err);
  }
}

// 10. –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ (–æ–ø—Ü—ñ–π–Ω–æ)
function openModal(labs) {
  const tbody = document.querySelector("#modalTable tbody");
  tbody.innerHTML = "";
  labs.forEach(lab => {
    const row = `
      <tr>
        <td>${lab.partner || "‚Äî"}</td>
        <td>${lab.city || "‚Äî"}</td>
        <td>${lab.institution || "‚Äî"}</td>
        <td>${lab.edrpou || "‚Äî"}</td>
        <td>${lab.manager || "‚Äî"}</td>
      </tr>
    `;
    tbody.innerHTML += row;
  });
  document.getElementById("mapModal").style.display = "block";
}

function closeModal() {
  document.getElementById("mapModal").style.display = "none";
}

// 11. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener("DOMContentLoaded", () => {
  initMap();
  fetchLabs();

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –±—É–¥—å-—è–∫–æ–≥–æ –ø–æ–ª—è
  document.querySelectorAll("#filters input, #filters select").forEach(el => {
    el.addEventListener("change", applyFilters);
  });

  // –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
  const resetBtn = document.querySelector("button[onclick='resetFilters()']");
  if (resetBtn) resetBtn.addEventListener("click", resetFilters);
});

function downloadExcel() {
  const table = document.getElementById("purchasesTable");
  if (!table) {
    alert("‚ùå –¢–∞–±–ª–∏—Ü—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞");
    return;
  }

  // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ HTML-—Ç–∞–±–ª–∏—Ü—é —É SheetJS-–æ–±'—î–∫—Ç
  const workbook = XLSX.utils.book_new();
  const worksheet = XLSX.utils.table_to_sheet(table);

  XLSX.utils.book_append_sheet(workbook, worksheet, "–ó–∞–∫—É–ø—ñ–≤–ª—ñ");

  // –ì–µ–Ω–µ—Ä—É—î–º–æ —Ñ–∞–π–ª Excel
 XLSX.writeFile(workbook, `zakupivli_${new Date().toISOString().split("T")[0]}.xlsx`);
}

</script>

  </body>
</html>