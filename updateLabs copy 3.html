<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Імпорт закупівель з Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Оновлення LabsDB з Excel (історія закупівель)</h2>
  <input type="file" id="fileInput" />
  <div id="progress">Очікування...</div>

<script>
function excelDateToJSDate(serial) {
  let utc_days = serial - 25569;
  let utc_value = utc_days * 86400;
  let date_info = new Date(utc_value * 1000);

  let day = String(date_info.getUTCDate()).padStart(2, "0");
  let month = String(date_info.getUTCMonth() + 1).padStart(2, "0");
  let year = date_info.getUTCFullYear();

  return `${day}.${month}.${year}`;
}

async function updateLabsDB(rows) {
  return new Promise((resolve, reject) => {
    let request = indexedDB.open("labsDB", 3);
    request.onsuccess = function(ev) {
      let db = ev.target.result;
      let tx = db.transaction("labs", "readwrite");
      let store = tx.objectStore("labs");

      let updatedCount = 0;

      (async () => {
        for (let r of rows) {
          let edrpou = String(r["окпо2"]).trim();
          let contragent = r["Контрагент"];
          let address = r["Адрес"];
          let period = typeof r["Период"] === "number" ? excelDateToJSDate(r["Период"]) : r["Период"];
          let quantity = r["Q(шт)"] || 0;
          let deviceName = r["апарат"];
          let isDevice = (String(r[Object.keys(r)[0]]).toUpperCase() === "TRUE");

          await new Promise(res => {
            let getReq = store.get(edrpou);
            getReq.onsuccess = function(e) {
              let record = e.target.result;
              if (!record) {
                record = {
                  edrpou: edrpou,
                  name: contragent,
                  address: address,
                  devices: []
                };
              }

              // гарантуємо наявність масиву devices
              if (!record.devices) {
                record.devices = [];
              }

              // шукаємо або створюємо прилад
              let device = record.devices.find(d => d.name === deviceName);
              if (!device) {
                device = { name: deviceName, purchases: [], reagents: [] };
                record.devices.push(device);
              }

              // гарантуємо наявність масивів
              if (!device.purchases) device.purchases = [];
              if (!device.reagents) device.reagents = [];

              if (isDevice) {
                device.purchases.push({ date: period, quantity: quantity });
              } else {
                device.reagents.push({ name: r["товар№1"], date: period, quantity: quantity });
              }

              store.put(record, record.edrpou);
              updatedCount++;
              console.log(`✅ Оновлено: ${edrpou}, ${deviceName}, isDevice=${isDevice}, кількість=${quantity}`);
              res();
            };
          });
        }
      })().then(() => {
        tx.oncomplete = () => resolve(updatedCount);
      });
    };
  });
}

document.getElementById("fileInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = async function(event) {
    const data = event.target.result;
    const workbook = XLSX.read(data, { type: "binary" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet);

    let updatedCount = await updateLabsDB(rows);
    document.getElementById("progress").innerText =
      `Завершено! Оновлено записів: ${updatedCount}`;
  };

  reader.readAsBinaryString(file);
});
</script>
</body>
</html>
